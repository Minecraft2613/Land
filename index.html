<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Land Registry</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <script src="noise.js"></script>
</head>

<body>

    <div class="container">
        <!-- Login Page -->
        <section id="login-view" class="view-section active">
            <div class="form-container">
                <h1 style="text-align: center; font-size: 2rem;">Land Registry</h1>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">Secure plots for your
                    server.</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="edition">Platform Edition</label>
                        <select id="edition" name="edition">
                            <option value="Java">Java Edition</option>
                            <option value="Bedrock">Bedrock Edition</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">Gamertag / Username</label>
                        <input type="text" id="name" name="name" placeholder="Stevie123" required>
                    </div>
                    <button type="submit" class="button login-button"
                        style="width: 100%; justify-content: center;">Authenticate</button>
                    <div id="messages" class="messages"></div>
                </form>
            </div>
        </section>

        <!-- Dashboard Page -->
        <section id="dashboard-view" class="view-section">
            <header class="app-header">
                <div>
                    <h1 id="dashboard-title">Dashboard</h1>
                    <p style="color: var(--text-muted);">Manage your real estate.</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="buy-land-button" class="button">
                        <span style="font-size: 1.2rem;">+</span> Buy Land
                    </button>
                    <button id="gov-panel-button" class="button"
                        style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706);">Gov Panel</button>
                    <button id="logout-button" class="button logout-button">Log Out</button>
                </div>
            </header>

            <div id="user-lands-list" class="card-grid"></div>
            <div id="dashboard-messages" class="messages"></div>
        </section>

        <!-- Buy Land Page -->
        <section id="buy-land-view" class="view-section">
            <header class="app-header">
                <h1>Purchase Plot</h1>
                <button id="back-from-buy-button" class="button logout-button">Back</button>
            </header>
            <div class="form-container">
                <form id="buy-land-form">
                    <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">Enter coordinates for
                        two opposite corners (X, Z). Y is automatically set to 1.</p>
                    <div class="form-grid">
                        <!-- Coordinates will be generated here -->
                    </div>

                    <div id="live-calculation-card"
                        style="display: none; margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Area</span>
                            <span style="font-weight: 700;"><span id="calc-blocks">0</span> blocks</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Base</span>
                            <span>$<span id="calc-base-cost">0.00</span></span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Tax (10%)</span>
                            <span>$<span id="calc-tax">0.00</span></span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">GST (3%)</span>
                            <span>$<span id="calc-gst">0.00</span></span>
                        </div>
                        <div
                            style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 0.5rem; display: flex; justify-content: space-between; color: var(--success);">
                            <span style="font-weight: 700;">TOTAL</span>
                            <span style="font-weight: 700; font-size: 1.2rem;">$<span
                                    id="calc-total-cost">0.00</span></span>
                        </div>
                    </div>

                    <button type="submit" class="button login-button"
                        style="width: 100%; justify-content: center; margin-top: 1.5rem;">Confirm Reservation</button>
                    <div id="buy-land-messages" class="messages"></div>
                </form>
            </div>
        </section>

        <!-- Government Panel Page -->
        <section id="gov-panel-view" class="view-section">
            <header class="app-header">
                <h1>Government Admin</h1>
                <button id="back-from-gov-button" class="button logout-button">Back</button>
            </header>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                <div class="land-card">
                    <h3>Global Settings</h3>
                    <form id="gov-settings-form">
                        <div class="form-group">
                            <label for="gov-gap">Plot Buffer (Blocks)</label>
                            <input type="number" id="gov-gap" name="gov-gap" required>
                        </div>
                        <div class="form-group">
                            <label for="gov-land-type">Reserved Land Label</label>
                            <input type="text" id="gov-land-type" name="gov-land-type" required>
                        </div>
                        <button type="submit" class="button">Apply Config</button>
                    </form>
                </div>

                <div class="land-card">
                    <h3>Zone Registration</h3>
                    <form id="register-gov-land-form">
                        <div class="form-group">
                            <label for="gov-land-gap">Player Gap Requirement</label>
                            <input type="number" id="gov-land-gap" name="gov-land-gap" required>
                        </div>
                        <div class="form-grid"></div>
                        <button type="submit" class="button" id="register-gov-land-button"
                            style="margin-top: 1rem;">Register Zone</button>
                    </form>
                </div>
            </div>

            <div id="gov-panel-messages" class="messages"></div>

            <div class="land-card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Treasury</h3>
                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">$<span
                        id="gov-balance">0.00</span></div>
            </div>

            <h3
                style="margin-bottom: 1rem; color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em;">
                Player Management</h3>
            <div id="player-management-section">
                <div id="owner-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
                </div>
                <div id="selected-player-plots" class="card-grid"></div>
            </div>
        </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-message" style="font-weight: 500;">Processing Request...</p>
    </div>

    <!-- Payment Status Overlay (Only for final success/failure result, not pending) -->
    <div id="payment-status-overlay" style="display: none;">
        <div id="payment-status-icon"></div>
        <p id="payment-status-message"></p>
        <button id="payment-status-close" class="button">Close</button>
    </div>

    <script>
        // Constants & Config
        const MAX_PLAYER_LAND_BLOCKS = 144000000000;
        const PLAYER_PLOT_GAP = 7;
        const API_URL = 'https://land.1987sakshamsingh.workers.dev';
        const WORLD_SEED = 67480912992;

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const loginMessages = document.getElementById('messages');
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutButton = document.getElementById('logout-button');
        const buyLandButton = document.getElementById('buy-land-button');
        const govPanelButton = document.getElementById('gov-panel-button');
        const userLandsList = document.getElementById('user-lands-list');
        const dashboardMessages = document.getElementById('dashboard-messages');
        const buyLandForm = document.getElementById('buy-land-form');
        const buyLandMessages = document.getElementById('buy-land-messages');
        const backFromBuyButton = document.getElementById('back-from-buy-button');
        const govSettingsForm = document.getElementById('gov-settings-form');
        const registerGovLandForm = document.getElementById('register-gov-land-form');
        const govPanelMessages = document.getElementById('gov-panel-messages');
        const backFromGovButton = document.getElementById('back-from-gov-button');
        const ownerButtonsContainer = document.getElementById('owner-buttons');
        const selectedPlayerPlotsContainer = document.getElementById('selected-player-plots');
        const paymentStatusOverlay = document.getElementById('payment-status-overlay');
        const buyLandSubmitButton = buyLandForm.querySelector('button[type="submit"]');
        const registerGovLandSubmitButton = registerGovLandForm.querySelector('button[type="submit"]');
        const views = document.querySelectorAll('.view-section');

        // State
        let currentUser = null;
        let users = [];
        let lands = [];
        let govConfig = { gap: 10, landType: 'Government' };
        let governmentBalance = 0;
        let selectedPlayerForManagement = null;
        let hasPendingPayment = false;
        let landCardTimers = {};

        // --- Core Functions ---

        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/data`);
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                users = data.users || [];
                lands = data.lands || [];
                govConfig = data.govConfig || { gap: 10, landType: 'Government' };
                governmentBalance = data.governmentBalance || 0;
            } catch (e) {
                console.error("Load failed:", e);
            }
        }

        async function saveData() {
            try {
                const response = await fetch(`${API_URL}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users, lands, govConfig, governmentBalance })
                });
                return await response.json();
            } catch (e) {
                console.error("Save failed", e);
                throw e;
            }
        }

        // --- Terrain Map System ---

        // --- Terrain Map System (Enhanced for 1.21 Accuracy) ---

        // Cyrb128 Hash: Better seeding for strings/large numbers
        function cyrb128(str) {
            let h1 = 1779033703, h2 = 3144134277,
                h3 = 1013904242, h4 = 2773480762;
            for (let i = 0, k; i < str.length; i++) {
                k = str.charCodeAt(i);
                h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
                h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
                h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
                h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
            }
            h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
            h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
            h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
            h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
            return [(h1 ^ h2 ^ h3 ^ h4) >>> 0, (h2 ^ h1) >>> 0, (h3 ^ h1) >>> 0, (h4 ^ h1) >>> 0];
        }

        function sfc32(a, b, c, d) {
            return function () {
                a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
                var t = (a + b) | 0;
                a = b ^ b >>> 9;
                b = c + (c << 3) | 0;
                c = (c << 21) | (c >>> 11);
                d = (d + 1) | 0;
                t = (t + d) | 0;
                c = (c + t) | 0;
                return (t >>> 0) / 4294967296;
            }
        }

        let terrainNoise = null;
        let biomeNoise = null;
        let riverNoise = null;

        function initNoise() {
            if (!terrainNoise) {
                const seedStr = WORLD_SEED.toString();
                const seedParts = cyrb128(seedStr);

                const rng1 = sfc32(seedParts[0], seedParts[1], seedParts[2], seedParts[3]);
                const rng2 = sfc32(seedParts[0], seedParts[1] + 100, seedParts[2], seedParts[3]);
                const rng3 = sfc32(seedParts[0], seedParts[1] + 200, seedParts[2], seedParts[3]);

                terrainNoise = new ClassicalNoise(rng1);
                biomeNoise = new ClassicalNoise(rng2);
                riverNoise = new ClassicalNoise(rng3);
            }
        }

        // Multi-octave FBM for detail
        function fbm(noiseObj, x, z, octaves, freq, amp) {
            let total = 0;
            let maxValue = 0;
            for (let i = 0; i < octaves; i++) {
                total += noiseObj.noise(x * freq, 0, z * freq) * amp;
                maxValue += amp;
                amp *= 0.5;
                freq *= 2;
            }
            return (total / maxValue) + 0.5;
        }

        function getNoise(x, z) {
            initNoise();
            // 1. Continentalness
            const hBase = fbm(terrainNoise, x, z, 4, 0.001, 1.0);

            // 2. Erosion / Rivers
            const riverRaw = riverNoise.noise(x * 0.0015, 0, z * 0.0015);
            const riverVal = Math.abs(riverRaw);

            // 3. Moisture
            const moisture = fbm(biomeNoise, x, z, 2, 0.002, 1.0);

            let height = hBase;

            // River Carving
            if (riverVal < 0.04 && hBase > 0.45) {
                const depth = (0.04 - riverVal) / 0.04;
                height = hBase - (depth * 0.15);
                if (height < 0.48) height = 0.44; // Force water
            }

            return { height, moisture, riverVal };
        }

        // --- Global Map System (Chunkbase Style) ---

        const WorldCache = {
            canvas: null,
            ctx: null,
            width: 2000, // World blocks width to cache
            height: 2000, // World blocks height to cache
            center: { x: 0, z: 0 }, // Center of the cached world
            isGenerated: false,

            init: function () {
                if (this.canvas) return;
                this.canvas = document.createElement('canvas');
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                this.ctx = this.canvas.getContext('2d');
            },

            generate: function () {
                if (!this.canvas) this.init();
                initNoise();

                const imageData = this.ctx.createImageData(this.width, this.height);
                const data = imageData.data;

                // We cache from [center.x - width/2, center.z - height/2]
                const startX = Math.floor(this.center.x - this.width / 2);
                const startZ = Math.floor(this.center.z - this.height / 2);

                for (let z = 0; z < this.height; z++) {
                    const wz = startZ + z;
                    for (let x = 0; x < this.width; x++) {
                        const wx = startX + x;

                        const { height: h, moisture: m } = getNoise(wx, wz);

                        let r, g, b;

                        // --- Chunkbase-ish Palette ---
                        // Distinct, solid colors. 

                        if (h < 0.45) {
                            // Deep Ocean
                            r = 60; g = 75; b = 112;
                        } else if (h < 0.49) {
                            // Ocean
                            r = 68; g = 85; b = 178;
                        } else if (h < 0.51) {
                            // Beach / Sand
                            r = 216; g = 198; b = 144;
                        } else {
                            // Land
                            if (h > 0.85) {
                                // Snow / Peaks
                                r = 255; g = 255; b = 255;
                            } else if (h > 0.70) {
                                // Stone / Mountains
                                r = 136; g = 136; b = 136;
                            } else {
                                // Vegetation
                                if (m < 0.25) {
                                    // Desert
                                    r = 216; g = 198; b = 144;
                                } else if (m < 0.45) {
                                    // Plains (Bright Green)
                                    r = 120; g = 168; b = 70;
                                } else if (m < 0.75) {
                                    // Forest (Darker Green)
                                    r = 72; g = 120; b = 46;
                                } else {
                                    // Jungle / Swamp
                                    r = 60; g = 90; b = 30;
                                }
                            }
                        }

                        // Hillshading (Fake 3D Top-Down)
                        // Simple derivative: is the neighbor higher?
                        // We can't easily check neighbor in this loop without 2 passes or noise recall.
                        // Recalling noise is fine for init.

                        // Sample North (-Z) height for shading
                        // Light comes from North-West usually in UI maps
                        const hNorth = getNoise(wx, wz - 1).height;
                        const hWest = getNoise(wx - 1, wz).height;

                        // Slope
                        const slope = (h - hNorth) + (h - hWest);
                        // If slope is positive (we are higher), it catches light (lighter).
                        // If slope is negative (we are lower), it is in shadow (darker).

                        const shade = slope * 250; // Strength

                        r = Math.max(0, Math.min(255, r + shade));
                        g = Math.max(0, Math.min(255, g + shade));
                        b = Math.max(0, Math.min(255, b + shade));

                        const idx = (z * this.width + x) * 4;
                        data[idx] = r;
                        data[idx + 1] = g;
                        data[idx + 2] = b;
                        data[idx + 3] = 255;
                    }
                }

                this.ctx.putImageData(imageData, 0, 0);
                this.isGenerated = true;
                console.log("Global Map Generated");
            },

            // Get the pixel data or draw coordinate for a slice
            drawSlice: function (targetCtx, targetW, targetH, worldRect) {
                if (!this.isGenerated) this.generate();

                // worldRect = { x, z, w, h } (in blocks)
                // We need to find where this rect is on our cached canvas.

                const cacheStartX = Math.floor(this.center.x - this.width / 2);
                const cacheStartZ = Math.floor(this.center.z - this.height / 2);

                const srcX = worldRect.x - cacheStartX;
                const srcZ = worldRect.z - cacheStartZ;
                const srcW = worldRect.w;
                const srcH = worldRect.h;

                // Draw from cache to target
                // disable smoothing for retro look
                targetCtx.imageSmoothingEnabled = false;

                targetCtx.drawImage(
                    this.canvas,
                    srcX, srcZ, srcW, srcH,
                    0, 0, targetW, targetH
                );
            }
        };

        function renderTerrainMap(canvasId, land) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Dynamic Sizing
            const rect = canvas.getBoundingClientRect();
            canvas.width = Math.floor(rect.width) || 300;
            canvas.height = Math.floor(rect.height) || 250;
            const w = canvas.width;
            const h = canvas.height;

            // Plot Info
            const c1 = land.coords[0];
            const c2 = land.coords[1];
            const pMinX = Math.min(c1.x, c2.x);
            const pMaxX = Math.max(c1.x, c2.x);
            const pMinZ = Math.min(c1.z, c2.z);
            const pMaxZ = Math.max(c1.z, c2.z);

            const plotW = pMaxX - pMinX + 1;
            const plotD = pMaxZ - pMinZ + 1;
            const plotCenterX = pMinX + (plotW / 2);
            const plotCenterZ = pMinZ + (plotD / 2);

            // Zoom Logic (Top Down)
            // Show plot + context.
            // Small plots: Show ~100 blocks wide context.
            // Large plots: Show 1.5x plot size.
            const maxDim = Math.max(plotW, plotD);
            const viewBlocks = Math.max(120, maxDim * 1.5);

            // Aspect Ratio Calc
            const aspect = w / h;
            let viewW, viewH;

            if (aspect > 1) {
                viewH = viewBlocks;
                viewW = viewBlocks * aspect;
            } else {
                viewW = viewBlocks;
                viewH = viewBlocks / aspect;
            }

            const viewMinX = Math.floor(plotCenterX - viewW / 2);
            const viewMinZ = Math.floor(plotCenterZ - viewH / 2);

            // Draw World Slice
            WorldCache.drawSlice(ctx, w, h, {
                x: viewMinX,
                z: viewMinZ,
                w: viewW,
                h: viewH
            });

            // Draw Boundaries
            // We need to project world coords to canvas coords
            const toCanvas = (wx, wz) => {
                return {
                    x: ((wx - viewMinX) / viewW) * w,
                    y: ((wz - viewMinZ) / viewH) * h
                };
            };

            const drawBox = (l, color, lineWidth, fill) => {
                const lx1 = Math.min(l.coords[0].x, l.coords[1].x);
                const lx2 = Math.max(l.coords[0].x, l.coords[1].x) + 1;
                const lz1 = Math.min(l.coords[0].z, l.coords[1].z);
                const lz2 = Math.max(l.coords[0].z, l.coords[1].z) + 1;

                // Culling
                if (lx2 < viewMinX || lx1 > viewMinX + viewW || lz2 < viewMinZ || lz1 > viewMinZ + viewH) return;

                const p1 = toCanvas(lx1, lz1);
                const p2 = toCanvas(lx2, lz2); // bottom-right logic

                const bx = p1.x;
                const by = p1.y;
                const bw = p2.x - p1.x;
                const bh = p2.y - p1.y;

                if (fill) {
                    ctx.fillStyle = fill;
                    ctx.fillRect(bx, by, bw, bh);
                }

                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.strokeRect(bx, by, bw, bh);

                // Label
                if (bw > 30) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.font = lineWidth > 1 ? 'bold 11px Inter' : '10px Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const name = l.owner.length > 8 ? l.owner.substring(0, 6) + '..' : l.owner;
                    ctx.fillText(name, bx + bw / 2, by + bh / 2);
                }
            };

            // Draw Other Lands first
            lands.forEach(l => {
                if (l === land) return; // Skip self for now
                const isMyLand = (l.owner === currentUser.minecraftName);
                // "Other" -> Red, "My Other" -> Dark Green
                drawBox(l, isMyLand ? '#166534' : '#dc2626', 1, isMyLand ? 'rgba(22, 101, 52, 0.2)' : 'rgba(220, 38, 38, 0.1)');
            });

            // Draw Current Land (Highlight)
            // 'reticle' style: Corner brackets? Or just bold box?
            // "You prefrer for optmization and also edit it" -> let's make it nice.

            // Bright Green Box
            drawBox(land, '#4ade80', 2, 'rgba(74, 222, 128, 0.1)');

            // Draw Coords?
        }


        // --- UI Rendering ---

        function renderLandCard(land) {
            const isPending = !land.paid;
            const statusClass = land.paid ? 'status-paid' : 'status-pending';
            const statusText = land.paid ? 'OWNED' : 'AWAITING BANK';
            const canvasId = `map-${land.id || land.paymentCode}`;

            const c1 = land.coords[0];
            const c2 = land.coords[1];

            return `
                <div class="land-card">
                    <canvas id="${canvasId}" class="land-map-canvas"></canvas>
                    
                    <div class="land-details">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
                            <h3>${land.landType} Plot</h3>
                            <span class="detail-value ${statusClass}" style="padding: 0.2rem 0.6rem; border-radius: 6px; background: rgba(0,0,0,0.4); font-size:0.6rem; font-weight:900; letter-spacing:0.05em;">${statusText}</span>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <div style="background:rgba(255,255,255,0.05); padding:0.5rem; border-radius:4px;">
                                <span style="color:var(--text-muted); display:block; font-size:0.7rem;">X Range</span>
                                <span class="detail-value">${Math.min(c1.x, c2.x)} ↔ ${Math.max(c1.x, c2.x)}</span>
                            </div>
                             <div style="background:rgba(255,255,255,0.05); padding:0.5rem; border-radius:4px;">
                                <span style="color:var(--text-muted); display:block; font-size:0.7rem;">Z Range</span>
                                <span class="detail-value">${Math.min(c1.z, c2.z)} ↔ ${Math.max(c1.z, c2.z)}</span>
                            </div>
                        </div>
                        <p style="text-align:right; font-size:0.8rem; color:var(--text-muted);">Area: <span style="color:var(--text-main);">${land.blocks.toLocaleString()} m²</span></p>
                    </div>

                    ${isPending ? `
                        <div class="pending-payment-section" style="border: 2px solid #f59e0b; background: rgba(245, 158, 11, 0.1); padding: 1.25rem; border-radius: 12px; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <h4 style="margin:0; color: #f59e0b; font-size: 0.8rem; font-weight: 900; text-transform: uppercase;">Payment Required</h4>
                                <p style="font-size: 0.7rem; color: #d1d5db; margin: 0.5rem 0;">Go to your <strong>Bank Dashboard</strong> to Accept and Pay for this land.</p>
                                <div style="font-size: 1.4rem; font-weight: 900; color: #fff; margin-bottom: 0.75rem;">$${parseFloat(land.cost).toFixed(2)}</div>
                                <a href="https://minecraft-bank-web.pages.dev" target="_blank" class="button" style="width:100%; justify-content:center; background: #f59e0b; color: #000; font-weight: 900; text-decoration: none; display: flex; align-items: center; border: none; border-radius: 8px; height: 40px;">Open Bank Dashboard ➔</a>
                                <p style="font-size: 0.6rem; color: #6b7280; margin-top: 0.75rem; font-style: italic;">Auto-refreshing status...</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderDashboard() {
            if (!currentUser) return;
            setView('dashboard-view');

            dashboardTitle.textContent = `Welcome, ${currentUser.minecraftName}`;
            govPanelButton.style.display = (currentUser.minecraftName.toLowerCase() === 'minecraft2613' || currentUser.minecraftName === 'ansh') ? 'flex' : 'none';

            const myLands = lands.filter(l => l.owner === currentUser.minecraftName);
            userLandsList.innerHTML = myLands.length ? myLands.map(renderLandCard).join('') : '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">You own no land. Start your empire today!</p>';

            myLands.forEach(land => {
                renderTerrainMap(`map-${land.id || land.paymentCode}`, land);
            });
        }

        // --- Fast Polling for Payment Confirmation ---
        setInterval(async () => {
            if (currentUser) {
                const oldPaidCount = lands.filter(l => l.owner === currentUser.minecraftName && l.paid).length;
                await loadData();
                const newPaidCount = lands.filter(l => l.owner === currentUser.minecraftName && l.paid).length;
                
                if (newPaidCount > oldPaidCount) {
                    showPaymentSuccess();
                    renderDashboard();
                } else {
                    renderDashboard();
                }
            }
        }, 5000);

        async function cancelPayment(code) {
            // New system handles this via Bank 'Decline'
        }

        // --- Buy Land Submit ---
        buyLandForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading("Requesting Bank Payment...");
            try {
                const coords = getFormCoordinates(buyLandForm, 2, 'player-coord');
                const details = calculatePlotDetails(coords);

                const payload = {
                    id: `LAND-${Date.now()}`,
                    owner: currentUser.minecraftName,
                    coords: coords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) })),
                    blocks: details.blocks,
                    cost: details.cost,
                    baseCost: details.baseCost,
                    tax: details.tax,
                    gst: details.gst,
                    gap: PLAYER_PLOT_GAP,
                    landType: 'Player'
                };

                const res = await fetch(`${API_URL}/reserve-land-web`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.success) {
                    alert("Plot Reserved! Go to your Bank Dashboard to pay.");
                    await loadData();
                    renderDashboard();
                } else {
                    alert("Bank Error: " + (json.error || json.message));
                }
            } catch (err) {
                console.error(err);
                alert("Bank Connection Failed");
            }
            hideLoading();
        });

        // Init
        loadData();
        // Helpers I preserved from original code for math
const calculatePlotDetails = (coords) => {
    if (!coords || coords.length < 2) return { isValid: false };

    const c1 = coords[0];
    const c2 = coords[1];

    if (
        c1.x === undefined || c1.z === undefined ||
        c2.x === undefined || c2.z === undefined
    ) return { isValid: false };

    const x1 = parseFloat(c1.x);
    const z1 = parseFloat(c1.z);
    const x2 = parseFloat(c2.x);
    const z2 = parseFloat(c2.z);

    if (isNaN(x1) || isNaN(z1) || isNaN(x2) || isNaN(z2))
        return { isValid: false };

    const width  = Math.abs(x1 - x2) + 1;
    const depth  = Math.abs(z1 - z2) + 1;
    const blocks = width * depth;

    const PRICE_PER_BLOCK = 3.9;
    const TAX_RATE = 0.39;   // 39%
    const GST_RATE = 0.39;   // 3%

    const baseCost = blocks * PRICE_PER_BLOCK;
    const tax = baseCost * TAX_RATE;
    const gst = baseCost * GST_RATE;
    const total = baseCost + tax + gst;

    const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

    return {
        isValid: true,
        blocks: blocks,
        baseCost: round2(baseCost),
        tax: round2(tax),
        gst: round2(gst),
        cost: round2(total)
    };
};
    </script>
</body>

</html>