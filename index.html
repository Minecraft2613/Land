<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Land Registry</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <script src="noise.js"></script>
</head>

<body>

    <div class="container">
        <!-- Login Page -->
        <section id="login-view" class="view-section active">
            <div class="form-container">
                <h1 style="text-align: center; font-size: 2rem;">Land Registry</h1>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">Secure plots for your
                    server.</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="edition">Platform Edition</label>
                        <select id="edition" name="edition">
                            <option value="Java">Java Edition</option>
                            <option value="Bedrock">Bedrock Edition</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">Gamertag / Username</label>
                        <input type="text" id="name" name="name" placeholder="Stevie123" required>
                    </div>
                    <button type="submit" class="button login-button"
                        style="width: 100%; justify-content: center;">Authenticate</button>
                    <div id="messages" class="messages"></div>
                </form>
            </div>
        </section>

        <!-- Dashboard Page -->
        <section id="dashboard-view" class="view-section">
            <header class="app-header">
                <div>
                    <h1 id="dashboard-title">Dashboard</h1>
                    <p style="color: var(--text-muted);">Manage your real estate.</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="buy-land-button" class="button">
                        <span style="font-size: 1.2rem;">+</span> Buy Land
                    </button>
                    <button id="gov-panel-button" class="button"
                        style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706);">Gov Panel</button>
                    <button id="logout-button" class="button logout-button">Log Out</button>
                </div>
            </header>

            <div id="user-lands-list" class="card-grid"></div>
            <div id="dashboard-messages" class="messages"></div>
        </section>

        <!-- Buy Land Page -->
        <section id="buy-land-view" class="view-section">
            <header class="app-header">
                <h1>Purchase Plot</h1>
                <button id="back-from-buy-button" class="button logout-button">Back</button>
            </header>
            <div class="form-container">
                <form id="buy-land-form">
                    <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">Enter coordinates for
                        two opposite corners (X, Z). Y is automatically set to 1.</p>
                    <div class="form-grid">
                        <!-- Coordinates will be generated here -->
                    </div>

                    <div id="live-calculation-card"
                        style="display: none; margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Area</span>
                            <span style="font-weight: 700;"><span id="calc-blocks">0</span> blocks</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Base</span>
                            <span>$<span id="calc-base-cost">0.00</span></span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Tax (39%)</span>
                            <span>$<span id="calc-tax">0.00</span></span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">GST (39%)</span>
                            <span>$<span id="calc-gst">0.00</span></span>
                        </div>
                        <div
                            style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 0.5rem; display: flex; justify-content: space-between; color: var(--success);">
                            <span style="font-weight: 700;">TOTAL</span>
                            <span style="font-weight: 700; font-size: 1.2rem;">$<span
                                    id="calc-total-cost">0.00</span></span>
                        </div>
                    </div>

                    <button type="submit" class="button login-button"
                        style="width: 100%; justify-content: center; margin-top: 1.5rem;">Confirm Reservation</button>
                    <div id="buy-land-messages" class="messages"></div>
                </form>
            </div>
        </section>

        <!-- Government Panel Page -->
        <section id="gov-panel-view" class="view-section">
            <header class="app-header">
                <h1>Government Admin</h1>
                <button id="back-from-gov-button" class="button logout-button">Back</button>
            </header>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                <div class="land-card">
                    <h3>Global Settings</h3>
                    <form id="gov-settings-form">
                        <div class="form-group">
                            <label for="gov-gap">Plot Buffer (Blocks)</label>
                            <input type="number" id="gov-gap" name="gov-gap" required>
                        </div>
                        <div class="form-group">
                            <label for="gov-land-type">Reserved Land Label</label>
                            <input type="text" id="gov-land-type" name="gov-land-type" required>
                        </div>
                        <button type="submit" class="button">Apply Config</button>
                    </form>
                </div>

                <div class="land-card">
                    <h3>Zone Registration</h3>
                    <form id="register-gov-land-form">
                        <div class="form-group">
                            <label for="gov-land-gap">Player Gap Requirement</label>
                            <input type="number" id="gov-land-gap" name="gov-land-gap" required>
                        </div>
                        <div class="form-grid"></div>
                        <button type="submit" class="button" id="register-gov-land-button"
                            style="margin-top: 1rem;">Register Zone</button>
                    </form>
                </div>
            </div>

            <div id="gov-panel-messages" class="messages"></div>

            <div class="land-card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Treasury</h3>
                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">$<span
                        id="gov-balance">0.00</span></div>
            </div>

            <h3
                style="margin-bottom: 1rem; color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em;">
                Player Management</h3>
            <div id="player-management-section">
                <div id="owner-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
                </div>
                <div id="selected-player-plots" class="card-grid"></div>
            </div>
        </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-message" style="font-weight: 500;">Processing Request...</p>
    </div>

    <!-- Payment Status Overlay (Only for final success/failure result, not pending) -->
    <div id="payment-status-overlay" style="display: none;">
        <div id="payment-status-icon"></div>
        <p id="payment-status-message"></p>
        <button id="payment-status-close" class="button">Close</button>
    </div>

    <script>
        // Constants & Config
        const MAX_PLAYER_LAND_BLOCKS = 144000000000;
        const PLAYER_PLOT_GAP = 7;
        const API_URL = 'https://land.1987sakshamsingh.workers.dev';
        const WORLD_SEED = 67480912992;

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const loginMessages = document.getElementById('messages');
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutButton = document.getElementById('logout-button');
        const buyLandButton = document.getElementById('buy-land-button');
        const govPanelButton = document.getElementById('gov-panel-button');
        const userLandsList = document.getElementById('user-lands-list');
        const dashboardMessages = document.getElementById('dashboard-messages');
        const buyLandForm = document.getElementById('buy-land-form');
        const buyLandMessages = document.getElementById('buy-land-messages');
        const backFromBuyButton = document.getElementById('back-from-buy-button');
        const govSettingsForm = document.getElementById('gov-settings-form');
        const registerGovLandForm = document.getElementById('register-gov-land-form');
        const govPanelMessages = document.getElementById('gov-panel-messages');
        const backFromGovButton = document.getElementById('back-from-gov-button');
        const ownerButtonsContainer = document.getElementById('owner-buttons');
        const selectedPlayerPlotsContainer = document.getElementById('selected-player-plots');
        const paymentStatusOverlay = document.getElementById('payment-status-overlay');
        const buyLandSubmitButton = buyLandForm.querySelector('button[type="submit"]');
        const registerGovLandSubmitButton = registerGovLandForm.querySelector('button[type="submit"]');
        const views = document.querySelectorAll('.view-section');

        // State
        let currentUser = null;
        let users = [];
        let lands = [];
        let govConfig = { gap: 10, landType: 'Government' };
        let governmentBalance = 0;
        let selectedPlayerForManagement = null;
        let hasPendingPayment = false;
        let landCardTimers = {};

        // --- Core Functions ---

        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/data`);
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                users = data.users || [];
                lands = data.lands || [];
                govConfig = data.govConfig || { gap: 10, landType: 'Government' };
                governmentBalance = data.governmentBalance || 0;
            } catch (e) {
                console.error("Load failed:", e);
            }
        }

        async function saveData() {
            try {
                const response = await fetch(`${API_URL}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users, lands, govConfig, governmentBalance })
                });
                return await response.json();
            } catch (e) {
                console.error("Save failed", e);
                throw e;
            }
        }

        // --- Terrain Map System ---

        // --- Terrain Map System (Enhanced for 1.21 Accuracy) ---

        // Cyrb128 Hash: Better seeding for strings/large numbers
        function cyrb128(str) {
            let h1 = 1779033703, h2 = 3144134277,
                h3 = 1013904242, h4 = 2773480762;
            for (let i = 0, k; i < str.length; i++) {
                k = str.charCodeAt(i);
                h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
                h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
                h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
                h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
            }
            h1 = Math.imul(h3 ^ (h1 >>> 18), 597399067);
            h2 = Math.imul(h4 ^ (h2 >>> 22), 2869860233);
            h3 = Math.imul(h1 ^ (h3 >>> 17), 951274213);
            h4 = Math.imul(h2 ^ (h4 >>> 19), 2716044179);
            return [(h1 ^ h2 ^ h3 ^ h4) >>> 0, (h2 ^ h1) >>> 0, (h3 ^ h1) >>> 0, (h4 ^ h1) >>> 0];
        }

        function sfc32(a, b, c, d) {
            return function () {
                a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
                var t = (a + b) | 0;
                a = b ^ b >>> 9;
                b = c + (c << 3) | 0;
                c = (c << 21) | (c >>> 11);
                d = (d + 1) | 0;
                t = (t + d) | 0;
                c = (c + t) | 0;
                return (t >>> 0) / 4294967296;
            }
        }

        let terrainNoise = null;
        let biomeNoise = null;
        let riverNoise = null;

        function initNoise() {
            if (!terrainNoise) {
                const seedStr = WORLD_SEED.toString();
                const seedParts = cyrb128(seedStr);

                const rng1 = sfc32(seedParts[0], seedParts[1], seedParts[2], seedParts[3]);
                const rng2 = sfc32(seedParts[0], seedParts[1] + 100, seedParts[2], seedParts[3]);
                const rng3 = sfc32(seedParts[0], seedParts[1] + 200, seedParts[2], seedParts[3]);

                terrainNoise = new ClassicalNoise(rng1);
                biomeNoise = new ClassicalNoise(rng2);
                riverNoise = new ClassicalNoise(rng3);
            }
        }

        // Multi-octave FBM for detail
        function fbm(noiseObj, x, z, octaves, freq, amp) {
            let total = 0;
            let maxValue = 0;
            for (let i = 0; i < octaves; i++) {
                total += noiseObj.noise(x * freq, 0, z * freq) * amp;
                maxValue += amp;
                amp *= 0.5;
                freq *= 2;
            }
            return (total / maxValue) + 0.5;
        }

        function getNoise(x, z) {
            initNoise();
            // 1. Continentalness
            const hBase = fbm(terrainNoise, x, z, 4, 0.001, 1.0);

            // 2. Erosion / Rivers
            const riverRaw = riverNoise.noise(x * 0.0015, 0, z * 0.0015);
            const riverVal = Math.abs(riverRaw);

            // 3. Moisture
            const moisture = fbm(biomeNoise, x, z, 2, 0.002, 1.0);

            let height = hBase;

            // River Carving
            if (riverVal < 0.04 && hBase > 0.45) {
                const depth = (0.04 - riverVal) / 0.04;
                height = hBase - (depth * 0.15);
                if (height < 0.48) height = 0.44; // Force water
            }

            return { height, moisture, riverVal };
        }

        // --- Global Map System (Chunkbase Style) ---

        const WorldCache = {
            canvas: null,
            ctx: null,
            width: 2000, // World blocks width to cache
            height: 2000, // World blocks height to cache
            center: { x: 0, z: 0 }, // Center of the cached world
            isGenerated: false,

            init: function () {
                if (this.canvas) return;
                this.canvas = document.createElement('canvas');
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                this.ctx = this.canvas.getContext('2d');
            },

            generate: function () {
                if (!this.canvas) this.init();
                initNoise();

                const imageData = this.ctx.createImageData(this.width, this.height);
                const data = imageData.data;

                // We cache from [center.x - width/2, center.z - height/2]
                const startX = Math.floor(this.center.x - this.width / 2);
                const startZ = Math.floor(this.center.z - this.height / 2);

                for (let z = 0; z < this.height; z++) {
                    const wz = startZ + z;
                    for (let x = 0; x < this.width; x++) {
                        const wx = startX + x;

                        const { height: h, moisture: m } = getNoise(wx, wz);

                        let r, g, b;

                        // --- Chunkbase-ish Palette ---
                        // Distinct, solid colors. 

                        if (h < 0.45) {
                            // Deep Ocean
                            r = 60; g = 75; b = 112;
                        } else if (h < 0.49) {
                            // Ocean
                            r = 68; g = 85; b = 178;
                        } else if (h < 0.51) {
                            // Beach / Sand
                            r = 216; g = 198; b = 144;
                        } else {
                            // Land
                            if (h > 0.85) {
                                // Snow / Peaks
                                r = 255; g = 255; b = 255;
                            } else if (h > 0.70) {
                                // Stone / Mountains
                                r = 136; g = 136; b = 136;
                            } else {
                                // Vegetation
                                if (m < 0.25) {
                                    // Desert
                                    r = 216; g = 198; b = 144;
                                } else if (m < 0.45) {
                                    // Plains (Bright Green)
                                    r = 120; g = 168; b = 70;
                                } else if (m < 0.75) {
                                    // Forest (Darker Green)
                                    r = 72; g = 120; b = 46;
                                } else {
                                    // Jungle / Swamp
                                    r = 60; g = 90; b = 30;
                                }
                            }
                        }

                        // Hillshading (Fake 3D Top-Down)
                        // Simple derivative: is the neighbor higher?
                        // We can't easily check neighbor in this loop without 2 passes or noise recall.
                        // Recalling noise is fine for init.

                        // Sample North (-Z) height for shading
                        // Light comes from North-West usually in UI maps
                        const hNorth = getNoise(wx, wz - 1).height;
                        const hWest = getNoise(wx - 1, wz).height;

                        // Slope
                        const slope = (h - hNorth) + (h - hWest);
                        // If slope is positive (we are higher), it catches light (lighter).
                        // If slope is negative (we are lower), it is in shadow (darker).

                        const shade = slope * 250; // Strength

                        r = Math.max(0, Math.min(255, r + shade));
                        g = Math.max(0, Math.min(255, g + shade));
                        b = Math.max(0, Math.min(255, b + shade));

                        const idx = (z * this.width + x) * 4;
                        data[idx] = r;
                        data[idx + 1] = g;
                        data[idx + 2] = b;
                        data[idx + 3] = 255;
                    }
                }

                this.ctx.putImageData(imageData, 0, 0);
                this.isGenerated = true;
                console.log("Global Map Generated");
            },

            // Get the pixel data or draw coordinate for a slice
            drawSlice: function (targetCtx, targetW, targetH, worldRect) {
                if (!this.isGenerated) this.generate();

                // worldRect = { x, z, w, h } (in blocks)
                // We need to find where this rect is on our cached canvas.

                const cacheStartX = Math.floor(this.center.x - this.width / 2);
                const cacheStartZ = Math.floor(this.center.z - this.height / 2);

                const srcX = worldRect.x - cacheStartX;
                const srcZ = worldRect.z - cacheStartZ;
                const srcW = worldRect.w;
                const srcH = worldRect.h;

                // Draw from cache to target
                // disable smoothing for retro look
                targetCtx.imageSmoothingEnabled = false;

                targetCtx.drawImage(
                    this.canvas,
                    srcX, srcZ, srcW, srcH,
                    0, 0, targetW, targetH
                );
            }
        };

        function renderTerrainMap(canvasId, land) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Dynamic Sizing
            const rect = canvas.getBoundingClientRect();
            canvas.width = Math.floor(rect.width) || 300;
            canvas.height = Math.floor(rect.height) || 250;
            const w = canvas.width;
            const h = canvas.height;

            // Plot Info
            const c1 = land.coords[0];
            const c2 = land.coords[1];
            const pMinX = Math.min(c1.x, c2.x);
            const pMaxX = Math.max(c1.x, c2.x);
            const pMinZ = Math.min(c1.z, c2.z);
            const pMaxZ = Math.max(c1.z, c2.z);

            const plotW = pMaxX - pMinX + 1;
            const plotD = pMaxZ - pMinZ + 1;
            const plotCenterX = pMinX + (plotW / 2);
            const plotCenterZ = pMinZ + (plotD / 2);

            // Zoom Logic (Top Down)
            // Show plot + context.
            // Small plots: Show ~100 blocks wide context.
            // Large plots: Show 1.5x plot size.
            const maxDim = Math.max(plotW, plotD);
            const viewBlocks = Math.max(120, maxDim * 1.5);

            // Aspect Ratio Calc
            const aspect = w / h;
            let viewW, viewH;

            if (aspect > 1) {
                viewH = viewBlocks;
                viewW = viewBlocks * aspect;
            } else {
                viewW = viewBlocks;
                viewH = viewBlocks / aspect;
            }

            const viewMinX = Math.floor(plotCenterX - viewW / 2);
            const viewMinZ = Math.floor(plotCenterZ - viewH / 2);

            // Draw World Slice
            WorldCache.drawSlice(ctx, w, h, {
                x: viewMinX,
                z: viewMinZ,
                w: viewW,
                h: viewH
            });

            // Draw Boundaries
            // We need to project world coords to canvas coords
            const toCanvas = (wx, wz) => {
                return {
                    x: ((wx - viewMinX) / viewW) * w,
                    y: ((wz - viewMinZ) / viewH) * h
                };
            };

            const drawBox = (l, color, lineWidth, fill) => {
                const lx1 = Math.min(l.coords[0].x, l.coords[1].x);
                const lx2 = Math.max(l.coords[0].x, l.coords[1].x) + 1;
                const lz1 = Math.min(l.coords[0].z, l.coords[1].z);
                const lz2 = Math.max(l.coords[0].z, l.coords[1].z) + 1;

                // Culling
                if (lx2 < viewMinX || lx1 > viewMinX + viewW || lz2 < viewMinZ || lz1 > viewMinZ + viewH) return;

                const p1 = toCanvas(lx1, lz1);
                const p2 = toCanvas(lx2, lz2); // bottom-right logic

                const bx = p1.x;
                const by = p1.y;
                const bw = p2.x - p1.x;
                const bh = p2.y - p1.y;

                if (fill) {
                    ctx.fillStyle = fill;
                    ctx.fillRect(bx, by, bw, bh);
                }

                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.strokeRect(bx, by, bw, bh);

                // Label
                if (bw > 30) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.font = lineWidth > 1 ? 'bold 11px Inter' : '10px Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const name = l.owner.length > 8 ? l.owner.substring(0, 6) + '..' : l.owner;
                    ctx.fillText(name, bx + bw / 2, by + bh / 2);
                }
            };

            // Draw Other Lands first
            lands.forEach(l => {
                if (l === land) return; // Skip self for now
                const isMyLand = (l.owner === currentUser.minecraftName);
                // "Other" -> Red, "My Other" -> Dark Green
                drawBox(l, isMyLand ? '#166534' : '#dc2626', 1, isMyLand ? 'rgba(22, 101, 52, 0.2)' : 'rgba(220, 38, 38, 0.1)');
            });

            // Draw Current Land (Highlight)
            // 'reticle' style: Corner brackets? Or just bold box?
            // "You prefrer for optmization and also edit it" -> let's make it nice.

            // Bright Green Box
            drawBox(land, '#4ade80', 2, 'rgba(74, 222, 128, 0.1)');

            // Draw Coords?
        }


        // --- UI Rendering ---

        function renderLandCard(land) {
            const isPending = !land.paid && land.paymentCode && (new Date().getTime() < land.expirationTime);
            const statusClass = land.paid ? 'status-paid' : (isPending ? 'status-pending' : 'status-expired');
            const statusText = land.paid ? 'OWNED' : (isPending ? 'RESERVED' : 'EXPIRED');
            const canvasId = `map-${land.id || land.paymentCode}`;

            const c1 = land.coords[0];
            const c2 = land.coords[1];

            return `
                <div class="land-card">
                    <canvas id="${canvasId}" class="land-map-canvas"></canvas>
                    
                    <div class="land-details">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
                            <h3>${land.landType} Plot</h3>
                            <span class="detail-value ${statusClass}" style="padding: 0.2rem 0.6rem; border-radius: 6px; background: rgba(0,0,0,0.4); font-size:0.75rem; letter-spacing:0.05em;">${statusText}</span>
                        </div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <div style="background:rgba(255,255,255,0.05); padding:0.5rem; border-radius:4px;">
                                <span style="color:var(--text-muted); display:block; font-size:0.7rem;">X Range</span>
                                <span class="detail-value">${Math.min(c1.x, c2.x)} ‚Üî ${Math.max(c1.x, c2.x)}</span>
                            </div>
                             <div style="background:rgba(255,255,255,0.05); padding:0.5rem; border-radius:4px;">
                                <span style="color:var(--text-muted); display:block; font-size:0.7rem;">Z Range</span>
                                <span class="detail-value">${Math.min(c1.z, c2.z)} ‚Üî ${Math.max(c1.z, c2.z)}</span>
                            </div>
                        </div>
                        <p style="text-align:right; font-size:0.8rem; color:var(--text-muted);">Area: <span style="color:var(--text-main);">${land.blocks.toLocaleString()} m¬≤</span></p>
                    </div>

                    ${isPending ? `
                        <div class="pending-payment-section" id="pending-section-${land.id || land.paymentCode}">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                                <h4 style="margin:0; color:var(--warning);">Payment Required</h4>
                                <span id="timer-${land.id || land.paymentCode}" class="timer-display" style="background:rgba(0,0,0,0.3); padding:0.1rem 0.4rem; border-radius:4px;">--:--</span>
                            </div>
                            
                            <div style="background:rgba(30, 41, 59, 0.5); border:1px solid rgba(255,255,255,0.1); padding:0.8rem; border-radius:8px; margin-bottom:0.8rem; text-align:center;">
                                <p style="margin:0 0 0.5rem 0; font-size:0.85rem; color:var(--text-muted);">Completing payment...</p>
                                <a href="https://minecraft-bank-web.pages.dev" target="_blank" class="button" style="width:100%; justify-content:center; background:var(--success); color:white; font-weight:700; border:none; text-decoration:none; display:flex; align-items:center; gap:0.5rem;">
                                    <span>üè¶</span> Go to Bank Dashboard
                                </a>
                                <p style="margin:0.5rem 0 0 0; font-size:0.7rem; color:var(--text-muted); font-style:italic;">Accept the prompt on your Home Page</p>
                            </div>
                            
                            <button class="button cancel-button" style="width:100%; justify-content:center; margin-top:0.2rem; font-size:0.75rem; padding:0.4rem; opacity:0.6;" onclick="cancelPayment('${land.id || land.paymentCode}')">Cancel Reservation</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderDashboard() {
            if (!currentUser) return;
            setView('dashboard-view');

            dashboardTitle.textContent = `Welcome, ${currentUser.minecraftName}`;
            govPanelButton.style.display = currentUser.minecraftName.toLowerCase() === 'minecraft2613' ? 'flex' : 'none';

            // Check pending payments globally to disable button
            hasPendingPayment = lands.some(l => !l.paid && l.owner === currentUser.minecraftName && new Date().getTime() < l.expirationTime);

            buyLandButton.disabled = hasPendingPayment;
            buyLandButton.style.opacity = hasPendingPayment ? '0.5' : '1';
            buyLandButton.innerHTML = hasPendingPayment ? '<span style="font-size:1.2rem; margin-right:0.5rem;">‚è≥</span> One Reservation Active' : '<span style="font-size:1.2rem; margin-right:0.5rem;">+</span> Buy Land';

            // Render Cards
            const myLands = lands.filter(l => l.owner === currentUser.minecraftName);
            userLandsList.innerHTML = myLands.length ? myLands.map(renderLandCard).join('') : '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">You own no land. Start your empire today!</p>';

            // Post-render: Initialize Maps and Timers
            myLands.forEach(land => {
                // Render Map
                renderTerrainMap(`map-${land.id || land.paymentCode}`, land);

                // Initialize Timer if pending
                if (!land.paid && (land.id || land.paymentCode) && new Date().getTime() < land.expirationTime) {
                    startCardTimer(land.id || land.paymentCode, land.expirationTime);
                }
            });
        }

        // --- Logic & Timers ---

        function startCardTimer(code, expiry) {
            if (landCardTimers[code]) clearInterval(landCardTimers[code]);

            const tick = () => {
                const now = new Date().getTime();
                const left = Math.ceil((expiry - now) / 1000);
                const el = document.getElementById(`timer-${code}`);

                if (!el) { clearInterval(landCardTimers[code]); return; }

                if (left <= 0) {
                    el.textContent = "Expired";
                    clearInterval(landCardTimers[code]);
                    // Auto-refresh to show expired state
                    loadData().then(renderDashboard);
                } else {
                    const m = Math.floor(left / 60).toString().padStart(2, '0');
                    const s = (left % 60).toString().padStart(2, '0');
                    el.textContent = `${m}:${s}`;
                }
            };

            tick();
            landCardTimers[code] = setInterval(tick, 1000);

            // Poll for payment success specifically for this card
            const poller = setInterval(async () => {
                await loadData();
                const l = lands.find(x => (x.id || x.paymentCode) === code);
                if (!l || l.paid) {
                    clearInterval(poller);
                    clearInterval(landCardTimers[code]);
                    if (l && l.paid) showPaymentSuccess();
                    renderDashboard();
                }
            }, 3000);
        }

        async function cancelPayment(code) {
            if (!confirm("Cancel this reservation?")) return;
            showLoading("Cancelling...");
            try {
                await fetch(`${API_URL}/cancel-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: code })
                });
                await loadData();
                renderDashboard();
            } catch (e) { console.error(e); }
            hideLoading();
        }

        // --- Form Handling ---

        function copyCommand(code, btn) {
            // Deprecated: No longer showing codes
        }

        function renderBuyLand() {
            setView('buy-land-view');
            renderCoordinatesForm(buyLandForm, 2, 'player');
            // Re-attach live calc listeners which are lost on innerHTML replace
            const inputs = buyLandForm.querySelectorAll('input');
            inputs.forEach(i => i.addEventListener('input', updateLiveCalc));
        }

        function updateLiveCalc() {
            const coords = getFormCoordinates(buyLandForm, 2, 'player-coord');
            const details = calculatePlotDetails(coords);
            const card = document.getElementById('live-calculation-card');

            if (details.isValid) {
                card.style.display = 'block';
                document.getElementById('calc-blocks').textContent = details.blocks.toLocaleString();
                document.getElementById('calc-base-cost').textContent = details.baseCost.toFixed(2);
                document.getElementById('calc-tax').textContent = details.tax.toFixed(2);
                document.getElementById('calc-gst').textContent = details.gst.toFixed(2);
                document.getElementById('calc-total-cost').textContent = details.cost.toFixed(2);
            } else {
                card.style.display = 'none';
            }
        }

        // Helpers
        function renderCoordinatesForm(el, count, type) {
            let html = '';
            for (let i = 1; i <= count; i++) {
                html += `<div class="form-group"><label>Point ${i}</label><div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                 <input type="number" name="${type}-coord-x-${i}" placeholder="X" required class="coord-input">
                 <!-- Y hidden -->
                 <input type="hidden" name="${type}-coord-y-${i}" value="1">
                 <input type="number" name="${type}-coord-z-${i}" placeholder="Z" required class="coord-input">
                 </div></div>`;
            }
            el.querySelector('.form-grid').innerHTML = html;
        }
        function getFormCoordinates(el, count, prefix) {
            const arr = [];
            for (let i = 1; i <= count; i++) {
                const x = el.querySelector(`[name="${prefix}-x-${i}"]`).value;
                const y = el.querySelector(`[name="${prefix}-y-${i}"]`).value || 1;
                const z = el.querySelector(`[name="${prefix}-z-${i}"]`).value;
                arr.push({ x, y, z });
            }
            return arr;
        }

        // --- Standard Utils ---

        function setView(id) {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showLoading(msg) {
            document.getElementById('loading-message').textContent = msg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        function showMessage(el, msg, type) {
            if (!el) return;
            el.textContent = msg;
            el.className = `messages message-${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
        function showPaymentSuccess() {
            const overlay = document.getElementById('payment-status-overlay');
            if (overlay) {
                // Minimal success interaction
                const audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
                audio.play().catch(e => { }); // ignore autoplay policy
                document.getElementById('payment-status-message').textContent = "Payment Successful!";
                document.getElementById('payment-status-icon').innerHTML = '<svg xmlns="http://www.w3.org/2001/svg" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="64" height="64"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                overlay.style.display = 'flex';
            }
        }

        // --- Init ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            if (!name) return;

            showLoading("Authenticating...");
            await loadData();

            let user = users.find(u => u.minecraftName === name);
            if (!user) {
                user = { minecraftName: name, minecraftEdition: document.getElementById('edition').value };
                users.push(user);
                await saveData();
            }
            currentUser = user;
            hideLoading();
            renderDashboard();
        });

        // Event Listeners for Buttons
        document.getElementById('logout-button').addEventListener('click', () => { window.location.reload(); });
        document.getElementById('payment-status-close').addEventListener('click', () => { document.getElementById('payment-status-overlay').style.display = 'none'; });
        buyLandButton.addEventListener('click', renderBuyLand);
        document.getElementById('back-from-buy-button').addEventListener('click', () => setView('dashboard-view'));

        // Buy Land Submit
        buyLandForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading("Reserving Plot...");
            try {
                const coords = getFormCoordinates(buyLandForm, 2, 'player-coord');
                const details = calculatePlotDetails(coords);

                const payload = {
                    id: `LAND-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                    owner: currentUser.minecraftName,
                    coords: coords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) })),
                    blocks: details.blocks,
                    cost: details.cost,
                    baseCost: details.baseCost,
                    tax: details.tax,
                    gst: details.gst,
                    gap: PLAYER_PLOT_GAP,
                    landType: 'Player'
                };

                const res = await fetch(`${API_URL}/reserve-land-web`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.success) {
                    // Notify Bank System to show upi-like notification
                    try {
                        const BANK_API_URL = 'https://minecraft-bank-backend.1987sakshamsingh.workers.dev';
                        await fetch(`${BANK_API_URL}/api/land/request-purchase`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                owner: currentUser.minecraftName,
                                cost: json.cost,
                                landData: payload,
                                id: json.id,
                                paymentCode: json.id // Compatibility
                            })
                        });
                    } catch (bankErr) {
                        console.error("Failed to notify Bank system", bankErr);
                    }

                    await loadData();
                    renderDashboard();
                } else {
                    alert("Error: " + json.message);
                }
            } catch (err) {
                console.error(err);
                alert("Reservation Failed");
            }
            hideLoading();
        });

        // Init
        loadData();
        // Helpers I preserved from original code for math
        const calculatePlotDetails = (coords) => {
            if (!coords || coords.length < 2) return { isValid: false };

            const c1 = coords[0];
            const c2 = coords[1];

            if (
                c1.x === undefined || c1.z === undefined ||
                c2.x === undefined || c2.z === undefined
            ) return { isValid: false };

            const x1 = parseFloat(c1.x);
            const z1 = parseFloat(c1.z);
            const x2 = parseFloat(c2.x);
            const z2 = parseFloat(c2.z);

            if (isNaN(x1) || isNaN(z1) || isNaN(x2) || isNaN(z2))
                return { isValid: false };

            const width = Math.abs(x1 - x2) + 1;
            const depth = Math.abs(z1 - z2) + 1;
            const blocks = width * depth;

            const PRICE_PER_BLOCK = 3.9;
            const TAX_RATE = 0.39;   // 39%
            const GST_RATE = 0.39;   // 3% (Restored from 0.39 code)

            const baseCost = blocks * PRICE_PER_BLOCK;
            const tax = baseCost * TAX_RATE;
            const gst = baseCost * GST_RATE;
            const total = baseCost + tax + gst;

            const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

            return {
                isValid: true,
                blocks: blocks,
                baseCost: round2(baseCost),
                tax: round2(tax),
                gst: round2(gst),
                cost: round2(total)
            };
        };
    </script>
</body>

</html>