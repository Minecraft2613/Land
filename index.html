<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Land Registry</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <script src="noise.js"></script>
</head>

<body>

    <div class="container">
        <!-- Login Page -->
        <section id="login-view" class="view-section active">
            <div class="form-container">
                <h1 style="text-align: center; font-size: 2rem;">Land Registry</h1>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">Secure plots for your
                    server.</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="edition">Platform Edition</label>
                        <select id="edition" name="edition">
                            <option value="Java">Java Edition</option>
                            <option value="Bedrock">Bedrock Edition</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">Gamertag / Username</label>
                        <input type="text" id="name" name="name" placeholder="Stevie123" required>
                    </div>
                    <button type="submit" class="button login-button"
                        style="width: 100%; justify-content: center;">Authenticate</button>
                    <div id="messages" class="messages"></div>
                </form>
            </div>
        </section>

        <!-- Dashboard Page -->
        <section id="dashboard-view" class="view-section">
            <header class="app-header">
                <div>
                    <h1 id="dashboard-title">Dashboard</h1>
                    <p style="color: var(--text-muted);">Manage your real estate.</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="buy-land-button" class="button">
                        <span style="font-size: 1.2rem;">+</span> Buy Land
                    </button>
                    <button id="gov-panel-button" class="button"
                        style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706);">Gov Panel</button>
                    <button id="logout-button" class="button logout-button">Log Out</button>
                </div>
            </header>

            <div id="user-lands-list" class="card-grid"></div>
            <div id="dashboard-messages" class="messages"></div>
        </section>

        <!-- Buy Land Page -->
        <section id="buy-land-view" class="view-section">
            <header class="app-header">
                <h1>Purchase Plot</h1>
                <button id="back-from-buy-button" class="button logout-button">Back</button>
            </header>
            <div class="form-container">
                <form id="buy-land-form">
                    <div class="form-grid">
                        <!-- Coordinates will be generated here -->
                    </div>

                    <div id="live-calculation-card"
                        style="display: none; margin-top: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Area</span>
                            <span style="font-weight: 700;"><span id="calc-blocks">0</span> blocks</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Base</span>
                            <span>$<span id="calc-base-cost">0.00</span></span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">Tax (10%)</span>
                            <span>$<span id="calc-tax">0.00</span></span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <span style="color: var(--text-muted);">GST (3%)</span>
                            <span>$<span id="calc-gst">0.00</span></span>
                        </div>
                        <div
                            style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 0.5rem; display: flex; justify-content: space-between; color: var(--success);">
                            <span style="font-weight: 700;">TOTAL</span>
                            <span style="font-weight: 700; font-size: 1.2rem;">$<span
                                    id="calc-total-cost">0.00</span></span>
                        </div>
                    </div>

                    <button type="submit" class="button login-button"
                        style="width: 100%; justify-content: center; margin-top: 1.5rem;">Confirm Reservation</button>
                    <div id="buy-land-messages" class="messages"></div>
                </form>
            </div>
        </section>

        <!-- Government Panel Page -->
        <section id="gov-panel-view" class="view-section">
            <header class="app-header">
                <h1>Government Admin</h1>
                <button id="back-from-gov-button" class="button logout-button">Back</button>
            </header>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                <div class="land-card">
                    <h3>Global Settings</h3>
                    <form id="gov-settings-form">
                        <div class="form-group">
                            <label for="gov-gap">Plot Buffer (Blocks)</label>
                            <input type="number" id="gov-gap" name="gov-gap" required>
                        </div>
                        <div class="form-group">
                            <label for="gov-land-type">Reserved Land Label</label>
                            <input type="text" id="gov-land-type" name="gov-land-type" required>
                        </div>
                        <button type="submit" class="button">Apply Config</button>
                    </form>
                </div>

                <div class="land-card">
                    <h3>Zone Registration</h3>
                    <form id="register-gov-land-form">
                        <div class="form-group">
                            <label for="gov-land-gap">Player Gap Requirement</label>
                            <input type="number" id="gov-land-gap" name="gov-land-gap" required>
                        </div>
                        <div class="form-grid"></div>
                        <button type="submit" class="button" id="register-gov-land-button"
                            style="margin-top: 1rem;">Register Zone</button>
                    </form>
                </div>
            </div>

            <div id="gov-panel-messages" class="messages"></div>

            <div class="land-card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">Treasury</h3>
                <div style="font-size: 2rem; font-weight: 700; color: var(--success);">$<span
                        id="gov-balance">0.00</span></div>
            </div>

            <h3
                style="margin-bottom: 1rem; color: var(--text-muted); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em;">
                Player Management</h3>
            <div id="player-management-section">
                <div id="owner-buttons" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;">
                </div>
                <div id="selected-player-plots" class="card-grid"></div>
            </div>
        </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-message" style="font-weight: 500;">Processing Request...</p>
    </div>

    <!-- Payment Status Overlay (Only for final success/failure result, not pending) -->
    <div id="payment-status-overlay" style="display: none;">
        <div id="payment-status-icon"></div>
        <p id="payment-status-message"></p>
        <button id="payment-status-close" class="button">Close</button>
    </div>

    <script>
        // Constants & Config
        const MAX_PLAYER_LAND_BLOCKS = 144000000000;
        const PLAYER_PLOT_GAP = 7;
        const API_URL = 'https://land.1987sakshamsingh.workers.dev';
        const WORLD_SEED = 67480912992;
        const ISO_ANGLE = Math.PI / 6; // 30 degrees

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const loginMessages = document.getElementById('messages'); // Fixed: was looking for 'messages' inside form maybe? No, global ID.
        const dashboardTitle = document.getElementById('dashboard-title');
        const logoutButton = document.getElementById('logout-button');
        const buyLandButton = document.getElementById('buy-land-button');
        const govPanelButton = document.getElementById('gov-panel-button');
        const userLandsList = document.getElementById('user-lands-list');
        const dashboardMessages = document.getElementById('dashboard-messages');
        const buyLandForm = document.getElementById('buy-land-form');
        const buyLandMessages = document.getElementById('buy-land-messages');
        const backFromBuyButton = document.getElementById('back-from-buy-button');
        const govSettingsForm = document.getElementById('gov-settings-form');
        const registerGovLandForm = document.getElementById('register-gov-land-form');
        const govPanelMessages = document.getElementById('gov-panel-messages');
        const backFromGovButton = document.getElementById('back-from-gov-button');
        const ownerButtonsContainer = document.getElementById('owner-buttons');
        const selectedPlayerPlotsContainer = document.getElementById('selected-player-plots');
        const paymentStatusOverlay = document.getElementById('payment-status-overlay');
        const buyLandSubmitButton = buyLandForm.querySelector('button[type="submit"]');
        const registerGovLandSubmitButton = registerGovLandForm.querySelector('button[type="submit"]');
        const views = document.querySelectorAll('.view-section');

        // State
        let currentUser = null;
        let users = [];
        let lands = [];
        let govConfig = { gap: 10, landType: 'Government' };
        let governmentBalance = 0;
        let selectedPlayerForManagement = null;
        let hasPendingPayment = false;
        let landCardTimers = {};

        // --- Core Functions ---

        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/data`);
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                users = data.users || [];
                lands = data.lands || [];
                govConfig = data.govConfig || { gap: 10, landType: 'Government' };
                governmentBalance = data.governmentBalance || 0;
            } catch (e) {
                console.error("Load failed:", e);
            }
        }

        async function saveData() {
            try {
                const response = await fetch(`${API_URL}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users, lands, govConfig, governmentBalance })
                });
                return await response.json();
            } catch (e) {
                console.error("Save failed", e);
                throw e;
            }
        }

        // --- Terrain Map System ---

        // Seeded PRNG
        function mulberry32(seed) {
            return function () {
                seed |= 0; seed = seed + 0x6D2B79F5 | 0;
                var t = Math.imul(seed ^ seed >>> 15, 1 | seed);
                t = t + Math.imul(t ^ t >>> 7, 61 | t) | 0;
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        let terrainNoise = null;

        function getNoise(x, y) {
            if (!terrainNoise) {
                const rng = mulberry32(WORLD_SEED);
                terrainNoise = new ClassicalNoise(rng);
            }
            // Simple fractal noise
            let val = 0;
            val += terrainNoise.noise(x * 0.02, y * 0.02, 0) * 1.0;
            val += terrainNoise.noise(x * 0.04, y * 0.04, 0) * 0.5;
            val += terrainNoise.noise(x * 0.08, y * 0.08, 0) * 0.25;
            // Normalize roughly -1.75 to 1.75 -> 0 to 1
            return (val + 1.75) / 3.5;
        }

        function renderTerrainMap(canvasId, land) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Fixed canvas size for card
            const width = canvas.offsetWidth || 300;
            const height = 200;
            canvas.width = width;
            canvas.height = height;

            // Coordinates
            const c1 = land.coords[0];
            const c2 = land.coords[1];
            // Determine viewing window. We want to show a bit of context around the plot.
            const minX = Math.min(c1.x, c2.x);
            const maxX = Math.max(c1.x, c2.x);
            const minZ = Math.min(c1.z, c2.z);
            const maxZ = Math.max(c1.z, c2.z);

            const plotW = maxX - minX + 1;
            const plotD = maxZ - minZ + 1;

            // Add padding (context)
            const pad = 8;
            const viewMinX = minX - pad;
            const viewMinZ = minZ - pad;
            const viewW = plotW + (pad * 2);
            const viewD = plotD + (pad * 2);

            // Calculate scale to fit
            const tileSize = Math.min(width / (viewW + viewD) * 1.6, 14);

            const centerX = width / 2;
            const centerY = height / 3.5;

            ctx.clearRect(0, 0, width, height);

            // 1. Render Terrain (Back to Front)
            for (let z = 0; z < viewD; z++) {
                for (let x = 0; x < viewW; x++) {
                    const wx = viewMinX + x;
                    const wz = viewMinZ + z;

                    const noiseVal = getNoise(wx, wz);
                    const isWater = noiseVal < 0.35;
                    const terrainHeight = Math.floor(noiseVal * 12);

                    // Improved Colors (Vibrant/Seed Map Style)
                    let topColor, sideColor;

                    if (isWater) {
                        topColor = '#4fa4f3'; // Brighter Water
                        sideColor = '#2b6cb0';
                    } else if (noiseVal < 0.45) {
                        topColor = '#e6c86e'; // Sand
                        sideColor = '#b79532';
                    } else if (noiseVal < 0.75) {
                        topColor = '#4ade80'; // Vibrant Grass
                        sideColor = '#16a34a';
                    } else if (noiseVal < 0.9) {
                        topColor = '#94a3b8'; // Stone
                        sideColor = '#475569';
                    } else {
                        topColor = '#f1f5f9'; // Snow
                        sideColor = '#cbd5e1';
                    }

                    // ISO projection
                    const isoX = (x - z) * tileSize * Math.cos(ISO_ANGLE) + centerX;
                    const isoY = (x + z) * tileSize * Math.sin(ISO_ANGLE) - (terrainHeight * 2) + centerY;

                    // Draw Block Side (Depth)
                    if (!isWater || wz === viewD - 1) {
                        ctx.fillStyle = sideColor;
                        ctx.beginPath();
                        ctx.moveTo(isoX - tileSize, isoY + tileSize / 2);
                        ctx.lineTo(isoX, isoY + tileSize);
                        ctx.lineTo(isoX, isoY + tileSize + (tileSize / 2)); // Taller sides for better definition
                        ctx.lineTo(isoX + tileSize, isoY + tileSize + (tileSize / 2));
                        ctx.lineTo(isoX + tileSize, isoY + tileSize / 2);
                        ctx.lineTo(isoX, isoY + tileSize);
                        ctx.lineTo(isoX - tileSize, isoY + tileSize / 2);
                        ctx.fill();
                    }

                    // Draw Block Top
                    ctx.fillStyle = topColor;
                    ctx.beginPath();
                    ctx.moveTo(isoX, isoY);
                    ctx.lineTo(isoX + tileSize, isoY + tileSize / 2);
                    ctx.lineTo(isoX, isoY + tileSize);
                    ctx.lineTo(isoX - tileSize, isoY + tileSize / 2);
                    ctx.fill();

                    // Highlight top slightly for 3D effect
                    ctx.fillStyle = 'rgba(255,255,255,0.05)';
                    ctx.fill();
                }
            }

            // 2. Render Solid Red Boundary (Draped over terrain)
            // We need to trace the perimeter.
            // Perimeter path: (minX, minZ) -> (maxX, minZ) -> (maxX, maxZ) -> (minX, maxZ) -> (minX, minZ)

            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.beginPath();

            const drawEdge = (x1, z1, x2, z2) => {
                // Interpolate points between corners to follow terrain height
                const dist = Math.max(Math.abs(x2 - x1), Math.abs(z2 - z1));
                for (let i = 0; i <= dist; i++) {
                    const t = i / dist;
                    const wx = Math.round(x1 + (x2 - x1) * t);
                    const wz = Math.round(z1 + (z2 - z1) * t);

                    // Calculate height at this specific block
                    const nVal = getNoise(wx, wz);
                    const tH = Math.floor(nVal * 12);

                    // Map to View local coords
                    const lx = wx - viewMinX;
                    const lz = wz - viewMinZ;

                    const scrX = (lx - lz) * tileSize * Math.cos(ISO_ANGLE) + centerX;
                    const scrY = (lx + lz) * tileSize * Math.sin(ISO_ANGLE) - (tH * 2) + centerY;

                    // We want to draw on the *outer edge* of the block top.
                    // But to keep it "solid" and simple, drawing through the center-top of the perimeter blocks is robust.
                    // Let's offset y slightly up to ensure it sits ON TOP of the blocks
                    if (i === 0 && x1 === minX && z1 === minZ) ctx.moveTo(scrX, scrY - tileSize / 2); // Start at top center
                    else ctx.lineTo(scrX, scrY - tileSize / 2);
                }
            };

            // Draw the 4 sides
            // Offset coordinates to align with block centers
            drawEdge(minX, minZ, maxX, minZ); // Top edge
            drawEdge(maxX, minZ, maxX, maxZ); // Right edge
            drawEdge(maxX, maxZ, minX, maxZ); // Bottom edge
            drawEdge(minX, maxZ, minX, minZ); // Left edge

            ctx.stroke();

            // Add a glow effect to the boundary
            ctx.shadowColor = '#ef4444';
            ctx.shadowBlur = 10;
            ctx.stroke();
            ctx.shadowBlur = 0; // reset
        }


        // --- UI Rendering ---

        function renderLandCard(land) {
            const isPending = !land.paid && land.paymentCode && (new Date().getTime() < land.expirationTime);
            const statusClass = land.paid ? 'status-paid' : (isPending ? 'status-pending' : 'status-expired');
            const statusText = land.paid ? 'OWNED' : (isPending ? 'RESERVED' : 'EXPIRED');
            const canvasId = `map-${land.id || land.paymentCode}`;

            // Coordinates string for display (minified)
            const c1 = land.coords[0];
            const c2 = land.coords[1];

            let html = `
                <div class="land-card">
                    <canvas id="${canvasId}" class="land-map-canvas"></canvas>
                    
                    <div class="land-details">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
                            <h3>${land.landType} Plot</h3>
                            <span class="detail-value ${statusClass}" style="font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(0,0,0,0.3);">${statusText}</span>
                        </div>
                        
                        <p><span>Coords:</span> <span class="detail-value">[${c1.x},${c1.z}] to [${c2.x},${c2.z}]</span></p>
                        <p><span>Blocks:</span> <span class="detail-value">${land.blocks.toLocaleString()}</span></p>
                        ${land.cost > 0 ? `<p><span>Value:</span> <span class="detail-value">$${land.cost.toFixed(2)}</span></p>` : ''}
                    </div>

                    ${isPending ? `
                        <div class="pending-payment-section" id="pending-section-${land.paymentCode}">
                            <h4>Complete Purchase</h4>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">Type this in-game:</p>
                            <code>/land payment ${land.paymentCode}</code>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <span id="timer-${land.paymentCode}" class="timer-display">--:--</span>
                                <button class="button cancel-button" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;" onclick="cancelPayment('${land.paymentCode}')">Cancel</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            return html;
        }

        async function renderDashboard() {
            if (!currentUser) return;
            setView('dashboard-view');

            dashboardTitle.textContent = `Welcome, ${currentUser.minecraftName}`;
            govPanelButton.style.display = currentUser.minecraftName.toLowerCase() === 'minecraft2613' ? 'flex' : 'none';

            // Check pending payments globally to disable button
            hasPendingPayment = lands.some(l => !l.paid && l.owner === currentUser.minecraftName && new Date().getTime() < l.expirationTime);

            buyLandButton.disabled = hasPendingPayment;
            buyLandButton.style.opacity = hasPendingPayment ? '0.5' : '1';
            buyLandButton.innerHTML = hasPendingPayment ? '<span style="font-size:1.2rem; margin-right:0.5rem;">‚è≥</span> One Reservation Active' : '<span style="font-size:1.2rem; margin-right:0.5rem;">+</span> Buy Land';

            // Render Cards
            const myLands = lands.filter(l => l.owner === currentUser.minecraftName);
            userLandsList.innerHTML = myLands.length ? myLands.map(renderLandCard).join('') : '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">You own no land. Start your empire today!</p>';

            // Post-render: Initialize Maps and Timers
            myLands.forEach(land => {
                // Render Map
                renderTerrainMap(`map-${land.id || land.paymentCode}`, land);

                // Initialize Timer if pending
                if (!land.paid && land.paymentCode && new Date().getTime() < land.expirationTime) {
                    startCardTimer(land.paymentCode, land.expirationTime);
                }
            });
        }

        // --- Logic & Timers ---

        function startCardTimer(code, expiry) {
            if (landCardTimers[code]) clearInterval(landCardTimers[code]);

            const tick = () => {
                const now = new Date().getTime();
                const left = Math.ceil((expiry - now) / 1000);
                const el = document.getElementById(`timer-${code}`);

                if (!el) { clearInterval(landCardTimers[code]); return; }

                if (left <= 0) {
                    el.textContent = "Expired";
                    clearInterval(landCardTimers[code]);
                    // Auto-refresh to show expired state
                    loadData().then(renderDashboard);
                } else {
                    const m = Math.floor(left / 60).toString().padStart(2, '0');
                    const s = (left % 60).toString().padStart(2, '0');
                    el.textContent = `${m}:${s}`;
                }
            };

            tick();
            landCardTimers[code] = setInterval(tick, 1000);

            // Poll for payment success specifically for this card
            const poller = setInterval(async () => {
                await loadData();
                const l = lands.find(x => x.paymentCode === code);
                if (!l || l.paid) {
                    clearInterval(poller);
                    clearInterval(landCardTimers[code]);
                    if (l && l.paid) showPaymentSuccess();
                    renderDashboard();
                }
            }, 3000);
        }

        async function cancelPayment(code) {
            if (!confirm("Cancel this reservation?")) return;
            showLoading("Cancelling...");
            try {
                await fetch(`${API_URL}/cancel-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentCode: code })
                });
                await loadData();
                renderDashboard();
            } catch (e) { console.error(e); }
            hideLoading();
        }

        // --- Form Handling ---

        function renderBuyLand() {
            setView('buy-land-view');
            renderCoordinatesForm(buyLandForm, 2, 'player');
            // Re-attach live calc listeners which are lost on innerHTML replace
            const inputs = buyLandForm.querySelectorAll('input');
            inputs.forEach(i => i.addEventListener('input', updateLiveCalc));
        }

        function updateLiveCalc() {
            const coords = getFormCoordinates(buyLandForm, 2, 'player-coord');
            const details = calculatePlotDetails(coords);
            const card = document.getElementById('live-calculation-card');

            if (details.isValid) {
                card.style.display = 'block';
                document.getElementById('calc-blocks').textContent = details.blocks.toLocaleString();
                document.getElementById('calc-base-cost').textContent = details.baseCost.toFixed(2);
                document.getElementById('calc-tax').textContent = details.tax.toFixed(2);
                document.getElementById('calc-gst').textContent = details.gst.toFixed(2);
                document.getElementById('calc-total-cost').textContent = details.cost.toFixed(2);
            } else {
                card.style.display = 'none';
            }
        }

        // --- Standard Utils ---

        function setView(id) {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function showLoading(msg) {
            document.getElementById('loading-message').textContent = msg;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        function showMessage(el, msg, type) {
            if (!el) return;
            el.textContent = msg;
            el.className = `messages message-${type}`;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
        function showPaymentSuccess() {
            const overlay = document.getElementById('payment-status-overlay');
            if (overlay) {
                // Minimal success interaction
                const audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
                audio.play().catch(e => { }); // ignore autoplay policy
                document.getElementById('payment-status-message').textContent = "Payment Successful!";
                document.getElementById('payment-status-icon').innerHTML = '<svg xmlns="http://www.w3.org/2001/svg" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" width="64" height="64"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                overlay.style.display = 'flex';
            }
        }

        // --- Init ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            if (!name) return;

            showLoading("Authenticating...");
            await loadData();

            let user = users.find(u => u.minecraftName === name);
            if (!user) {
                user = { minecraftName: name, minecraftEdition: document.getElementById('edition').value };
                users.push(user);
                await saveData();
            }
            currentUser = user;
            hideLoading();
            renderDashboard();
        });

        // Event Listeners for Buttons
        document.getElementById('logout-button').addEventListener('click', () => { window.location.reload(); });
        document.getElementById('payment-status-close').addEventListener('click', () => { document.getElementById('payment-status-overlay').style.display = 'none'; });
        buyLandButton.addEventListener('click', renderBuyLand);
        document.getElementById('back-from-buy-button').addEventListener('click', () => setView('dashboard-view'));

        // Buy Land Submit
        buyLandForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading("Reserving Plot...");
            try {
                const coords = getFormCoordinates(buyLandForm, 2, 'player-coord');
                const details = calculatePlotDetails(coords); // reuse existing logic

                // Construct payload manually since verify logic is client-side here
                // Note: Production should verify server-side
                const payload = {
                    owner: currentUser.minecraftName,
                    coords: coords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) })),
                    blocks: details.blocks,
                    cost: details.cost,
                    baseCost: details.baseCost,
                    tax: details.tax,
                    gst: details.gst,
                    gap: PLAYER_PLOT_GAP,
                    landType: 'Player'
                };

                const res = await fetch(`${API_URL}/reserve-land-web`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.success) {
                    await loadData();
                    renderDashboard();
                } else {
                    alert("Error: " + json.message);
                }
            } catch (err) {
                console.error(err);
                alert("Reservation Failed");
            }
            hideLoading();
        });

        // Init
        loadData();

        // Helpers I preserved from original code for math
        function renderCoordinatesForm(el, count, type) {
            let html = '';
            for (let i = 1; i <= count; i++) {
                html += `<div class="form-group"><label>Point ${i}</label><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                 <input type="number" name="${type}-coord-x-${i}" placeholder="X" required class="coord-input">
                 <input type="number" name="${type}-coord-y-${i}" placeholder="Y" required class="coord-input">
                 <input type="number" name="${type}-coord-z-${i}" placeholder="Z" required class="coord-input">
                 </div></div>`;
            }
            el.querySelector('.form-grid').innerHTML = html;
        }
        function getFormCoordinates(el, count, prefix) {
            const arr = [];
            for (let i = 1; i <= count; i++) {
                const x = el.querySelector(`[name="${prefix}-x-${i}"]`).value;
                const y = el.querySelector(`[name="${prefix}-y-${i}"]`).value;
                const z = el.querySelector(`[name="${prefix}-z-${i}"]`).value;
                arr.push({ x, y, z });
            }
            return arr;
        }
        const calculatePlotDetails = (coords) => {
            // simplified port of original logic to keep compatible
            if (coords.length < 2) return { isValid: false };
            const c1 = coords[0]; const c2 = coords[1];
            if (!c1.x || !c2.x) return { isValid: false };
            const width = Math.abs(c1.x - c2.x) + 1;
            const depth = Math.abs(c1.z - c2.z) + 1;
            const blocks = width * depth;
            const base = blocks * 10;
            return { isValid: true, blocks: blocks, baseCost: base, tax: base * 0.1, gst: base * 0.03, cost: base * 1.13 };
        };

    </script>
</body>

</html>