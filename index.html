<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Land Registry</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <!-- Login Page -->
        <section id="login-view" class="view-section active">
            <div class="form-container">
                <h2>Minecraft Land Registry</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="edition">Minecraft Edition</label>
                        <select id="edition" name="edition">
                            <option value="Java">Java</option>
                            <option value="Bedrock">Bedrock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="name">Minecraft Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <button type="submit" class="button login-button">Login</button>
                </form>
                <div id="messages" class="messages"></div>
            </div>
        </section>

        <!-- Dashboard Page -->
        <section id="dashboard-view" class="view-section">
            <header class="app-header">
                <h1 id="dashboard-title"></h1>
                <button id="logout-button" class="button logout-button">Logout</button>
            </header>
            <div class="nav-buttons">
                <button id="buy-land-button" class="button">Buy New Land</button>
                <button id="gov-panel-button" class="button" style="display: none;">Government Panel</button>
            </div>
            <h3 style="margin-bottom: 20px;">Your Purchased Lands</h3>
            <div id="user-lands-list" class="card-grid"></div>
            <div id="dashboard-messages" class="messages"></div>
        </section>

        <!-- Buy Land Page -->
        <section id="buy-land-view" class="view-section">
            <header class="app-header">
                <h1>Buy New Land</h1>
                <button id="back-from-buy-button" class="button logout-button">Back</button>
            </header>
            <div class="form-container">
                <form id="buy-land-form">
                    <div class="form-grid">
                        <!-- Coordinates will be generated here -->
                    </div>
                    <div id="live-calculation-card" class="land-card" style="display: none; margin-bottom: 20px;">
                        <h3>Live Calculation</h3>
                        <p>Blocks: <span id="calc-blocks" class="detail-value">0</span></p>
                        <p>Base Cost: $<span id="calc-base-cost" class="detail-value">0.00</span></p>
                        <p>10% Tax: $<span id="calc-tax" class="detail-value">0.00</span></p>
                        <p>3% GST: $<span id="calc-gst" class="detail-value">0.00</span></p>
                        <h4 style="margin-top: 15px;">Total Cost: $<span id="calc-total-cost" class="detail-value">${(0).toFixed(2)}</span></h4>
                    </div>
                    <button type="submit" class="button login-button">Submit & Purchase</button>
                </form>
                <div id="buy-land-messages" class="messages"></div>
                <div id="payment-section" class="land-card" style="display: none; margin-top: 20px;">
                    <h3>Complete Your Purchase In-Game</h3>
                    <div class="gpay-timer-container">
                        <div class="gpay-circle">
                            <span id="countdown">5:00</span>
                        </div>
                    </div>
                    <p>Your land has been reserved. Use the following command in-game:</p>
                    <p><code>/land payment <span id="payment-code"></span> <button id="copy-code-button">Copy</button></code></p>
                    <p>Amount: $<span id="payment-amount"></span></p>
                    <p class="messages message-error" id="payment-warning" style="display: none;">Warning: Payment code will expire soon!</p>
                </div>
            </div>
        </section>

        <!-- Government Panel Page -->
        <section id="gov-panel-view" class="view-section">
            <header class="app-header">
                <h1>Government Panel</h1>
                <button id="back-from-gov-button" class="button logout-button">Back</button>
            </header>
            <div class="form-container" style="max-width: 800px;">
                <div class="card-grid">
                    <div class="land-card">
                        <h3>Government Settings</h3>
                        <form id="gov-settings-form">
                            <div class="form-group">
                                <label for="gov-gap">Government Plot Gap (Blocks)</label>
                                <input type="number" id="gov-gap" name="gov-gap" required>
                            </div>
                            <div class="form-group">
                                <label for="gov-land-type">Type of Land</label>
                                <input type="text" id="gov-land-type" name="gov-land-type" required>
                            </div>
                            <button type="submit" class="button login-button">Save Settings</button>
                        </form>
                    </div>

                    <div class="land-card">
                        <h3>Register Government Land</h3>
                        <form id="register-gov-land-form">
                            <!-- Coords will be generated here -->
                        </form>
                        <button type="submit" class="button login-button" id="register-gov-land-button">Register Land</button>
                    </div>
                </div>
                <div id="gov-panel-messages" class="messages"></div>
                <div class="land-card" style="margin-top: 20px;">
                    <h3>Government Balance</h3>
                    <p>Current Balance: $<span id="gov-balance" class="detail-value">0.00</span></p>
                </div>
                <div class="land-card" style="margin-top: 20px;">
                    <h3>Government Balance</h3>
                    <p>Current Balance: $<span id="gov-balance" class="detail-value">0.00</span></p>
                </div>
                <div class="land-card" style="margin-top: 20px;">
                    <h3>Government Balance</h3>
                    <p>Current Balance: $<span id="gov-balance" class="detail-value">0.00</span></p>
                </div>
                <div class="land-card" style="margin-top: 20px;">
                    <h3>Government Balance</h3>
                    <p>Current Balance: $<span id="gov-balance" class="detail-value">0.00</span></p>
                </div>
            </div>
            
            <h3 style="margin-top: 30px; margin-bottom: 20px;">Player Plot Management</h3>
            <div id="player-management-section">
                <div id="owner-buttons" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"></div>
                <div id="selected-player-plots" class="card-grid"></div>
            </div>
        </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-message">Processing...</p>
    </div>

    <!-- Payment Status Overlay -->
    <div id="payment-status-overlay" style="display: none;">
        <div id="payment-status-icon"></div>
        <p id="payment-status-message"></p>
        <button id="payment-status-close" class="button">Close</button>
    </div>

    <script>
        // Constants
        const MAX_PLAYER_LAND_BLOCKS = 14400;
        const PLAYER_PLOT_GAP = 7;
        const API_URL = 'https://land.1987sakshamsingh.workers.dev';

        // Global state variables
        let currentUser = null;
        let users = [];
        let lands = [];
        let govConfig = { gap: 10, landType: 'Government' };
        let governmentBalance = 0;
        let selectedPlayerForManagement = null;

        // DOM elements
        const views = document.querySelectorAll('.view-section');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const dashboardTitle = document.getElementById('dashboard-title');
        const userLandsList = document.getElementById('user-lands-list');
        const buyLandButton = document.getElementById('buy-land-button');
        const govPanelButton = document.getElementById('gov-panel-button');
        const backFromBuyButton = document.getElementById('back-from-buy-button');
        const backFromGovButton = document.getElementById('back-from-gov-button');
        const buyLandForm = document.getElementById('buy-land-form');
        const govSettingsForm = document.getElementById('gov-settings-form');
        const registerGovLandForm = document.getElementById('register-gov-land-form');
        const ownerButtonsContainer = document.getElementById('owner-buttons');
        const selectedPlayerPlotsContainer = document.getElementById('selected-player-plots');
        const buyLandSubmitButton = buyLandForm.querySelector('button[type="submit"]');
        const registerGovLandSubmitButton = document.getElementById('register-gov-land-button');
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const paymentStatusOverlay = document.getElementById('payment-status-overlay');
        const paymentStatusIcon = document.getElementById('payment-status-icon');
        const paymentStatusMessage = document.getElementById('payment-status-message');
        const paymentStatusCloseButton = document.getElementById('payment-status-close');

        // Message displays
        const loginMessages = document.getElementById('messages');
        const dashboardMessages = document.getElementById('dashboard-messages');
        const buyLandMessages = document.getElementById('buy-land-messages');
        const govPanelMessages = document.getElementById('gov-panel-messages');

        function showMessage(element, message, type = 'success') {
            element.textContent = message;
            element.className = `messages ${type === 'success' ? 'message-success' : 'message-error'}`;
            if (type === 'success') {
                element.classList.add('animate');
            }
            setTimeout(() => {
                element.textContent = '';
                element.className = 'messages';
            }, 5000);
        }

        function showLoading(message) {
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showPaymentStatus(success, message) {
            paymentStatusOverlay.className = success ? 'success' : 'error';
            paymentStatusIcon.innerHTML = success ? '&#10004;' : '&#10008;'; // Checkmark or X
            paymentStatusMessage.textContent = message;
            paymentStatusOverlay.style.display = 'flex';
        }

        paymentStatusCloseButton.addEventListener('click', () => {
            paymentStatusOverlay.style.display = 'none';
            renderDashboard(); // Go back to dashboard after closing status
        });

        // --- Data Persistence and Loading (Updated to use fetch API) ---
        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/data`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data from API. Status: ${response.status}`);
                }
                const data = await response.json();
                users = data.users || [];
                lands = data.lands || [];
                govConfig = data.govConfig || { gap: 10, landType: 'Government' };
                governmentBalance = data.governmentBalance || 0;
            } catch (e) {
                console.error("Could not load data from API", e);
                showMessage(dashboardMessages, 'Failed to load data from the server. Please check the API URL.', 'error');
            }
        }

        async function saveData() {
            try {
                const response = await fetch(`${API_URL}/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users, lands, govConfig, governmentBalance })
                });
                if (!response.ok) {
                    throw new Error(`Failed to save data to API. Status: ${response.status}`);
                }
                const result = await response.json();
                console.log('Data saved:', result);
                return result; // Return the result on success
            } catch (e) {
                console.error("Could not save data to API", e);
                showMessage(dashboardMessages, 'Failed to save data to the server. Please check the API URL.', 'error');
                throw e; // Re-throw the error so calling functions know it failed
            }
        }

        // --- Utility Functions ---
        const calculatePlotDetails = (coords) => {
            const numericCoords = coords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) }));
            if (numericCoords.some(c => isNaN(c.x) || isNaN(c.y) || isNaN(c.z))) {
                return { blocks: 0, cost: 0, baseCost: 0, tax: 0, gst: 0, isValid: false };
            }

            const minX = Math.min(...numericCoords.map(c => c.x));
            const maxX = Math.max(...numericCoords.map(c => c.x));
            const minZ = Math.min(...numericCoords.map(c => c.z));
            const maxZ = Math.max(...numericCoords.map(c => c.z));

            const blockWidth = Math.abs(maxX - minX) + 1;
            const blockDepth = Math.abs(maxZ - minZ) + 1;
            const totalBlocks = blockWidth * blockDepth;

            const baseCost = totalBlocks * 10;
            const tax = baseCost * 0.10;
            const gst = baseCost * 0.03;
            const totalCost = baseCost + tax + gst;
            
            return { blocks: totalBlocks, cost: totalCost, baseCost, tax, gst, isValid: true };
        };

        const isColliding = (newPlotCoords, existingPlots, newPlotType, newPlotGap) => {
            const numericNewPlotCoords = newPlotCoords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) }));
            const newMinX = Math.min(...numericNewPlotCoords.map(c => c.x));
            const newMaxX = Math.max(...numericNewPlotCoords.map(c => c.x));
            const newMinZ = Math.min(...numericNewPlotCoords.map(c => c.z));
            const newMaxZ = Math.max(...numericNewPlotCoords.map(c => c.z));

            for (const existingPlot of existingPlots) {
                const existingMinX = Math.min(...existingPlot.coords.map(c => c.x));
                const existingMaxX = Math.max(...existingPlot.coords.map(c => c.x));
                const existingMinZ = Math.min(...existingPlot.coords.map(c => c.z));
                const existingMaxZ = Math.max(...existingPlot.coords.map(c => c.z));

                let effectiveNewPlotGap = 0;
                let effectiveExistingPlotGap = 0;

                // Determine effective gap based on plot types
                if (newPlotType === 'Player' && existingPlot.landType === 'Player') {
                    effectiveNewPlotGap = newPlotGap;
                    effectiveExistingPlotGap = existingPlot.gap;
                } else if (newPlotType === 'Player' && existingPlot.landType !== 'Player') { // Player vs Gov
                    effectiveNewPlotGap = newPlotGap;
                    effectiveExistingPlotGap = existingPlot.gap;
                } else if (newPlotType !== 'Player' && existingPlot.landType === 'Player') { // Gov vs Player
                    effectiveNewPlotGap = newPlotGap;
                    effectiveExistingPlotGap = existingPlot.gap;
                } else if (newPlotType !== 'Player' && existingPlot.landType !== 'Player') { // Gov vs Gov
                    effectiveNewPlotGap = 0; // No gap for government plots
                    effectiveExistingPlotGap = 0; // No gap for government plots
                }

                const newPlotWithGapMinX = newMinX - effectiveNewPlotGap;
                const newPlotWithGapMaxX = newMaxX + effectiveNewPlotGap;
                const newPlotWithGapMinZ = newMinZ - effectiveNewPlotGap;
                const newPlotWithGapMaxZ = newMaxZ + effectiveNewPlotGap;

                const existingPlotWithGapMinX = existingMinX - effectiveExistingPlotGap;
                const existingPlotWithGapMaxX = existingMaxX + effectiveExistingPlotGap;
                const existingPlotWithGapMinZ = existingMinZ - effectiveExistingPlotGap;
                const existingPlotWithGapMaxZ = existingMaxZ + effectiveExistingPlotGap;

                // Check for overlap on the X-axis
                const overlapX = Math.max(newPlotWithGapMinX, existingPlotWithGapMinX) < Math.min(newPlotWithGapMaxX, existingPlotWithGapMaxX);
                // Check for overlap on the Z-axis
                const overlapZ = Math.max(newPlotWithGapMinZ, existingPlotWithGapMinZ) < Math.min(newPlotWithGapMaxZ, existingPlotWithGapMaxZ);

                if (overlapX && overlapZ) {
                    showMessage(buyLandMessages, `Collision detected with an existing plot owned by ${existingPlot.owner} (${existingPlot.landType} land)! Please choose a different location.`, 'error');
                    return true;
                }
            }
            return false;
        };

        // --- View Switching ---
        function setView(viewId) {
            views.forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        // --- Rendering Functions ---
        function renderDashboard() {
            if (!currentUser) return;
            setView('dashboard-view');
            dashboardTitle.textContent = `Welcome, ${currentUser.minecraftName}!`; // Removed balance display
            
            // Check for government access
            govPanelButton.style.display = currentUser.minecraftName.toLowerCase() === 'minecraft2613' ? 'block' : 'none';

            // Filter lands for the current user and render them
            const userPlots = lands.filter(land => land.owner === currentUser.minecraftName);
            userLandsList.innerHTML = userPlots.map(renderLandCard).join('');

            if (userPlots.length === 0) {
                userLandsList.innerHTML = '<p style="text-align: center; color: var(--text-dark);">You do not own any land yet.</p>';
            }
        }
        
        function renderBuyLand() {
            setView('buy-land-view');
            renderCoordinatesForm(buyLandForm, 4, 'player');
            const coordsInputs = buyLandForm.querySelectorAll('.coord-input');
            const liveCalculationCard = document.getElementById('live-calculation-card');

            // Add event listeners for live calculation
            coordsInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const coords = getFormCoordinates(buyLandForm);
                    const calculatedDetails = calculatePlotDetails(coords);

                    if (calculatedDetails.isValid) {
                        liveCalculationCard.style.display = 'block';
                        document.getElementById('calc-blocks').textContent = calculatedDetails.blocks;
                        document.getElementById('calc-base-cost').textContent = calculatedDetails.baseCost.toFixed(2);
                        document.getElementById('calc-tax').textContent = calculatedDetails.tax.toFixed(2);
                        document.getElementById('calc-gst').textContent = calculatedDetails.gst.toFixed(2);
                        document.getElementById('calc-total-cost').textContent = calculatedDetails.cost.toFixed(2);
                    } else {
                        liveCalculationCard.style.display = 'none';
                    }
                });
            });
        }
        
        function renderGovPanel() {
            setView('gov-panel-view');
            renderCoordinatesForm(registerGovLandForm, 4, 'gov');
            
            // Populate settings form with current values
            document.getElementById('gov-gap').value = govConfig.gap;
            document.getElementById('gov-land-type').value = govConfig.landType;
            document.getElementById('gov-balance').textContent = governmentBalance.toFixed(2);
            
            // Render owner buttons
            const allOwners = [...new Set(lands.map(land => land.owner))];
            ownerButtonsContainer.innerHTML = allOwners.map(owner => `
                <button class="button" data-owner="${owner}">${owner}</button>
            `).join('');

            // Display plots for the currently selected player, or an empty message
            if (selectedPlayerForManagement) {
                displayPlayerPlots(selectedPlayerForManagement);
            } else {
                selectedPlayerPlotsContainer.innerHTML = '<p style="text-align: center; color: var(--text-dark);">Select a player to view their plots.</p>';
            }
        }
        
        function renderLandCard(land) {
            return `
                <div class="land-card">
                    <h3>Plot Owner: ${land.owner}</h3>
                    <p>Blocks: <span class="detail-value">${land.blocks}</span></p>
                    <p>Type: <span class="detail-value">${land.landType}</span></p>
                    <p>Coordinates:</p>
                    <ul>
                        ${land.coords.map(c => `<li>(${c.x}, ${c.y}, ${c.z})</li>`).join('')}
                    </ul>
                    ${land.cost > 0 ? `<p>Cost: $<span class="detail-value">${land.cost.toFixed(2)}</span></p>` : ''}
                    <p>Status: <span class="detail-value">${land.paid ? 'Paid' : 'Pending'}</span></p>
                </div>
            `;
        }
        
        function renderCoordinatesForm(formElement, count, type) {
            const formGrid = formElement.querySelector('.form-grid') || formElement;
            let html = '';
            for (let i = 1; i <= count; i++) {
                html += `
                    <div class="form-group">
                        <label>Point ${i}</label>
                        <input type="number" name="${type}-coord-x-${i}" placeholder="X" class="coord-input" required>
                        <input type="number" name="${type}-coord-y-${i}" placeholder="Y" class="coord-input" required>
                        <input type="number" name="${type}-coord-z-${i}" placeholder="Z" class="coord-input" required>
                    </div>
                `;
            }
            formGrid.innerHTML = html;
        }

        function getFormCoordinates(formElement, count = 4, prefix = 'player-coord') {
            const coords = [];
            for (let i = 1; i <= count; i++) {
                const x = formElement.querySelector(`input[name="${prefix}-x-${i}"]`)?.value;
                const y = formElement.querySelector(`input[name="${prefix}-y-${i}"]`)?.value;
                const z = formElement.querySelector(`input[name="${prefix}-z-${i}"]`)?.value;
                coords.push({ x, y, z });
            }
            return coords;
        }

        function displayPlayerPlots(owner) {
            selectedPlayerForManagement = owner;
            const playerPlots = lands.filter(land => land.owner === owner);
            selectedPlayerPlotsContainer.innerHTML = playerPlots.map(renderLandCard).join('');
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const minecraftName = document.getElementById('name').value.trim();
            const minecraftEdition = document.getElementById('edition').value;
            
            if (!minecraftName) {
                showMessage(loginMessages, 'Please enter a Minecraft name.', 'error');
                return;
            }

            showLoading('Logging in...');
            await loadData(); // Load latest data before login

            let existingUser = users.find(u => u.minecraftName === minecraftName && u.minecraftEdition === minecraftEdition);
            if (existingUser) {
                currentUser = existingUser;
            } else {
                currentUser = { minecraftName, minecraftEdition, wallet: 1000.00 }; // Default starting balance
                users.push(currentUser);
            }

            await saveData();
            hideLoading();
            renderDashboard();
        });

        logoutButton.addEventListener('click', () => {
            currentUser = null;
            setView('login-view');
        });

        buyLandButton.addEventListener('click', () => renderBuyLand());
        govPanelButton.addEventListener('click', () => renderGovPanel());
        backFromBuyButton.addEventListener('click', () => renderDashboard());
        backFromGovButton.addEventListener('click', () => renderDashboard());

        buyLandForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = buyLandSubmitButton;
            button.disabled = true;

            try {
                const coords = getFormCoordinates(buyLandForm, 4, 'player-coord');
                const calculatedDetails = calculatePlotDetails(coords);

                if (!calculatedDetails.isValid) {
                    showMessage(buyLandMessages, 'Please enter valid numeric coordinates for all 4 points.', 'error');
                    return;
                }

                if (calculatedDetails.blocks > MAX_PLAYER_LAND_BLOCKS) {
                    showMessage(buyLandMessages, `Plot is too large. Max size is ${MAX_PLAYER_LAND_BLOCKS} blocks.`, 'error');
                    return;
                }
                
                // Removed balance check from web

                const newCoords = coords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) }));
                const isCollision = isColliding(newCoords, lands, 'Player', PLAYER_PLOT_GAP);
                if (isCollision) {
                    hideLoading();
                    return;
                }

                const paymentCode = generatePaymentCode();
                const newLand = {
                    owner: currentUser.minecraftName,
                    coords: newCoords,
                    blocks: calculatedDetails.blocks,
                    cost: calculatedDetails.cost,
                    gap: PLAYER_PLOT_GAP,
                    landType: 'Player',
                    paymentCode: paymentCode,
                    purchaseTime: new Date().getTime(),
                    paid: false
                };

                lands.push(newLand);
                
                showLoading('Reserving land...');
                await saveData();
                hideLoading();

                document.getElementById('payment-code').textContent = paymentCode;
                document.getElementById('payment-amount').textContent = calculatedDetails.cost.toFixed(2);
                document.getElementById('payment-section').style.display = 'block';

                showMessage(buyLandMessages, 'Land reserved! Please complete the payment in-game.', 'success');

                startCountdown(300); // 5 minutes in seconds

            } catch (error) {
                console.error("Buy land submission error:", error);
                hideLoading();
                showPaymentStatus(false, 'An error occurred during reservation.');
            } finally {
                button.disabled = false;
            }
        });

        govSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newGap = parseInt(document.getElementById('gov-gap').value, 10);
            const newLandType = document.getElementById('gov-land-type').value.trim();

            if (isNaN(newGap) || newGap < 0) {
                showMessage(govPanelMessages, 'Please enter a valid gap.', 'error');
                return;
            }
            if (!newLandType) {
                showMessage(govPanelMessages, 'Please enter a valid land type.', 'error');
                return;
            }

            govConfig.gap = newGap;
            govConfig.landType = newLandType;
            await saveData();
            showMessage(govPanelMessages, 'Government settings updated successfully!', 'success');
            renderGovPanel();
        });

        registerGovLandForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = registerGovLandSubmitButton;
            button.disabled = true;

            try {
                const govCoords = getFormCoordinates(registerGovLandForm, 4, 'gov-coord');
                const calculatedDetails = calculatePlotDetails(govCoords);

                if (!calculatedDetails.isValid) {
                    showMessage(govPanelMessages, 'Please enter valid numeric coordinates for all 4 points.', 'error');
                    return;
                }

                const newCoords = govCoords.map(c => ({ x: parseFloat(c.x), y: parseFloat(c.y), z: parseFloat(c.z) }));
                const isCollision = isColliding(newCoords, lands, govConfig.landType, govConfig.gap);
                if (isCollision) {
                    return;
                }

                const newLand = {
                    owner: currentUser.minecraftName,
                    coords: newCoords,
                    blocks: calculatedDetails.blocks,
                    cost: 0,
                    gap: govConfig.gap,
                    landType: govConfig.landType,
                    paymentCode: null, // Government lands don't need payment codes
                    purchaseTime: new Date().getTime(),
                    paid: true // Government lands are considered paid immediately
                };

                lands.push(newLand);
                await saveData();
                showMessage(govPanelMessages, `Successfully registered new government land: ${govConfig.landType}!`, 'success');
                renderGovPanel();
            } catch (error) {
                console.error("Gov land submission error:", error);
                showMessage(govPanelMessages, 'An error occurred while processing your request.', 'error');
            } finally {
                button.disabled = false;
            }
        });

        ownerButtonsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.owner) {
                displayPlayerPlots(button.dataset.owner);
            }
        });
        
        function generatePaymentCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        let countdownInterval;

        function startCountdown(duration) {
            let timer = duration;
            const countdownElement = document.getElementById('countdown');
            const paymentWarning = document.getElementById('payment-warning');

            clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                countdownElement.textContent = minutes + ":" + seconds;

                if (timer <= 60) { // Warn when 1 minute or less remains
                    paymentWarning.style.display = 'block';
                } else {
                    paymentWarning.style.display = 'none';
                }

                if (--timer < 0) {
                    clearInterval(countdownInterval);
                    countdownElement.textContent = "EXPIRED";
                    paymentWarning.textContent = "Payment code has expired!";
                    paymentWarning.style.display = 'block';
                    // Optionally disable payment section or clear code
                }
            }, 1000);
        }

        document.getElementById('copy-code-button').addEventListener('click', () => {
            const paymentCode = document.getElementById('payment-code').textContent;
            navigator.clipboard.writeText(`/land payment ${paymentCode}`).then(() => {
                alert('Command copied to clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            if (currentUser) {
                renderDashboard();
            } else {
                setView('login-view');
            }
        });
    </script>
</body>
</html>